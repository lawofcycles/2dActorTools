<!doctype html>

<html>
<head>
	<meta charset="utf-8">
	<script src="./ext.js"></script>
	<script src="./lib/CSInterface.js"></script>
	<script src="./lib/jquery-1.9.1.js"></script>
	<script src="./node_modules/uikit/dist/js/uikit.min.js"></script>
	<script src="./node_modules/uikit/dist/js/uikit-icons.min.js"></script>
	<script src="./node_modules/sortablejs/dist/sortable.umd.js"></script>
	<script src="./lib/Vulcan.js"></script>
	<script src="node_modules/lightbox2/dist/js/lightbox.js"></script>
	<link id="tdactorstyle" href="css/tdActor.css" rel="stylesheet" type="text/css">
	<link id="uikitstyle" href="node_modules/uikit/dist/css/uikit.min.css" rel="stylesheet" type="text/css">
	<link id="lightboxstyle" href="node_modules/lightbox2/dist/css/lightbox.css" rel="stylesheet" type="text/css">
</head>

<body onLoad="onLoaded();loadSetup();mogrtUpdate();actorSelectBoxUpdate();LoadSettings()">
	
	<div class='uk-flex-center'>
		<a href="javascript:history.go(0)" uk-icon="icon: refresh"></a>
		<a href="#" id='setting_file_not_exist_icon' class='uk-align-right' uk-toggle="target: #settigs_file_modal" uk-icon="icon: warning" style="color:yellow; visibility: hidden;" uk-tooltip="title: 設定ファイルがありません。ここをクリックして保存先を指定してください。; pos: bottom-right"></a>
	</div>

	<div id="settigs_file_modal" uk-modal>
		<div class="uk-modal-dialog uk-modal-body">
			<button class="uk-modal-close-default" id="setting_save_modal_close" type="button" uk-close></button>
			<p>設定ファイル</p>
			<div class="uk-flex-center uk-child-width-expand@ss uk-margin-left uk-margin-right" uk-grid>
				<button class="uk-button uk-button-secondary uk-button-small uk-padding-remove-left uk-margin-small-left uk-margin-small-right" onClick="NewSettingFile()">保存</button>
				<button class="uk-button uk-button-secondary uk-button-small uk-padding-remove-left uk-margin-small-left uk-margin-small-right" onClick="ImportSettingFile()">インポート</button>
			</div>
		</div>
	</div>
	
	<div id="busy_notification" uk-modal='esc-close:false; bg-close:false' class="uk-modal">
		<div class="uk-modal-dialog uk-modal-body">
			<div style="text-align:center">サムネイル用画像の処理中</div>
		</div>
	</div>

	<div id="mainfunc">
		<ul class="uk-flex-center" id="function_switch" uk-tab="active: 0;">
			<li id="function_subtitle"><a href="#">字幕</a></li>
			<li id="function_property_deploy"><a href="#">リファインツール</a></li>
			<li id="function_actor"><a href="#">立ち絵</a></li>
			<li id="function_actor_setting"><a href="#">立ち絵設定</a></li>
			<li id="function_auto_import"><a href="#">自動インポート</a></li>
		</ul>

		<ul class="uk-switcher" id='actor_functions'>
			<li>
				<div class='uk-flex-center uk-child-width-expand@ss uk-margin-left uk-margin-right' id='actor_controle_div'>
					<button class="uk-button uk-button-secondary uk-button-small uk-margin-small-left uk-margin-small-right" onClick="importMGT()">mogrtのインポート</button>
					<hr>
					<span class="uk-label tdactor_label uk-width-auto">トラックに並べるMOGRTを選択</span>
					<select class="tdactor_selectbox uk-width-expand uk-select" id="select_mogrt"></select>
					<span class="uk-label tdactor_label uk-width-auto">プリセットタグ</span>
					<input class="uk-input uk-light tdinput" type="text" id="preset_tag" value="＞" placeholder="preset tag...">
					<span class="uk-label tdactor_label uk-width-auto uppercase_disable">Replace（正規表現）</span>
					<div class='uk-flex-inline'>
						<input category='insert_subtitle' class="uk-input uk-light tdinput save_setting_value_on_change" type="text" id="subtitle_replace" value="" placeholder="マッチングパターン">
						<input category='insert_subtitle' class="uk-input uk-light tdinput save_setting_value_on_change" type="text" id="subtitle_replace_flag" value="" placeholder="フラグ">
						<input category='insert_subtitle' class="uk-input uk-light tdinput save_setting_value_on_change" type="text" id="subtitle_replace_after" value="" placeholder="Replace後">
					</div>
					<details open>
						<summary class="mogrt_source_summary">ソース：Audioと同じフォルダにあるtxtファイル</summary>
						<div class='uk-flex-center uk-child-width-expand@ss uk-margin-left uk-margin-right' id='actor_controle_div'>
							<button class="uk-button uk-button-secondary uk-button-small uk-margin-small-right" style='margin-top:8px;' onClick="insertSubtitleFromTextFile()">ターゲットトラックにMOGRTを並べる</button>
						</div>
					</details>

					<details style="margin-top:10px;padding-bottom:10px;">
						<summary class="mogrt_source_summary">ソース：テキストエリア</summary>
						<div class='uk-flex-center uk-child-width-expand@ss uk-margin-left uk-margin-right' id='actor_controle_div'>
							<span class="uk-label tdactor_label uk-width-auto">トラックに並べるテキストを入力</span>
							<textarea id="subtitles" rows="12" wrap="off" placeholder="input subtitles"></textarea>
							<button class="uk-button uk-button-secondary uk-button-small uk-margin-small-left uk-margin-small-right" style='margin-top:8px;' onClick="insertSubtitleFromTextarea()">ターゲットトラックにMOGRTを並べる</button>
						</div>
					</details>
				</div>
				<div>
				</div>

			</li>
			<li>
				<div class="uk-margin-left uk-width-auto" uk-toggle="target: #offcanvas-nav"><a href="#" class="uk-margin-small-right" uk-icon="icon: menu"></a></div>
				<hr>
				<div id="offcanvas-nav" uk-offcanvas="overlay: true">
					<div class="uk-offcanvas-bar">
						<button class="uk-offcanvas-close" type="button" uk-close></button>
						<ul class="uk-nav uk-nav-default" uk-switcher="connect: .my-class">
							<li class="uk-nav-header">ツールリスト</li>
							<li class="uk-nav-divider"></li>
							<li class="uk-active"><a href="#">プロパティコピー</a></li>
							<li><a href="#">自動改行</a></li>
							<li><a href="#">トリガークリップオーバーライト</a></li>
						</ul>
					</div>
				</div>

				<ul class="uk-switcher my-class uk-margin">
					<li class="uk-active">
						<div class='uk-flex-center uk-child-width-expand@ss uk-margin-left uk-margin-right'>
							<span class="uk-label tdactor_label uk-width-auto">対象のクリップを選択してコピー/ペーストボタンをクリック</span>
							<div class="uk-flex-center uk-child-width-expand@ss uk-margin-left uk-margin-right" uk-grid>
								<button class="uk-button uk-button-secondary uk-button-small uk-padding-remove-left uk-margin-small-left uk-margin-small-right" onClick="propertyCapture()">コピー</button>
								<button class="uk-button uk-button-secondary uk-button-small uk-padding-remove-left uk-margin-small-left uk-margin-small-right" onClick="propertyDeploy()">ペースト</button>
							</div>
						</div>
						<div id="capturedParameters">
						</div>
					</li>
					<li>
						<div class="uk-flex-center uk-child-width-expand@ss uk-margin-left uk-margin-right">
							<div class="uk-margin"><label><input id="auto_newline_ascii" category="autonewline" class="uk-checkbox td_check save_setting_check_on_change" type="checkbox" checked> 半角英数字は0.5文字としてカウントする</label></div>
							<div class="uk-margin"><label><input id="auto_newline_marker" category="autonewline" class="uk-checkbox td_check save_setting_check_on_change" type="checkbox" checked onclick="autoNewLineMarkerUIUpdate()"> 改行対象のクリップ位置にマーカーを付ける</label></div>
							<div class="uk-margin-left uk-flex-inline uk-flex-middle" id="auto_newline_normal_marker_color" category="autonewline">
								<div class="uk-margin-left"></div>
								<div class="merker_color_selector" style="background-color: #718637;"></div>
								<div class="merker_color_selector" style="background-color: #D22C36;"></div>
								<div class="merker_color_selector" style="background-color: #AF8BB1;"></div>
								<div class="merker_color_selector" style="background-color: #E96F24;"></div>
								<div class="merker_color_selector" style="background-color: #D0A12B;"></div>
								<div class="merker_color_selector" style="background-color: #FFFFFF;"></div>
								<div class="merker_color_selector" style="background-color: #428DFC;"></div>
								<div class="merker_color_selector" style="background-color: #19F4D6;"></div>
							</div>
							<div class="uk-margin-left uk-margin">
								<label><input id="auto_newline_maxlinecount" category="autonewline" class="uk-input uk-light tdinput input_num_only save_setting_value_on_change uk-form-small uk-form-width-xsmall uk-margin-left uk-margin-right" type="text" placeholder="行数" value="2">行を超える、もしくは分割できない場合のマーカーの色</label>
							</div>
							<div class="uk-margin-left uk-flex-inline uk-flex-middle" id="auto_newline_warning_marker_color" category="autonewline">
								<div class="uk-margin-left"></div>
								<div class="merker_color_selector" style="background-color: #718637;"></div>
								<div class="merker_color_selector" style="background-color: #D22C36;"></div>
								<div class="merker_color_selector" style="background-color: #AF8BB1;"></div>
								<div class="merker_color_selector" style="background-color: #E96F24;"></div>
								<div class="merker_color_selector" style="background-color: #D0A12B;"></div>
								<div class="merker_color_selector" style="background-color: #FFFFFF;"></div>
								<div class="merker_color_selector" style="background-color: #428DFC;"></div>
								<div class="merker_color_selector" style="background-color: #19F4D6;"></div>
							</div>
							<div class="uk-margin"><label><input id="auto_newline_flatten" category="autonewline" class="uk-checkbox td_check save_setting_check_on_change" type="checkbox" checked> 処理する前に改行を消す</label></div>
							<div class="uk-margin"><label><input id="auto_newline_insert" category="autonewline" class="uk-checkbox td_check save_setting_check_on_change" type="checkbox" checked> 自動で改行する</label></div>
							<div class="uk-margin">
								<label>
									1行の文字数<input id="auto_newline_maxcount" category="autonewline" class="uk-input uk-light tdinput input_num_only save_setting_value_on_change uk-form-small uk-form-width-xsmall uk-margin-left uk-margin-right" type="text" value="35">
									<a href="#" class="" onClick="countSelectedClipTextLength()" uk-icon="icon: pencil" uk-tooltip="選択中のクリップの文字数を取得"></a>
								</label>
							</div>
						</div>
						<div class="uk-flex-center uk-child-width-expand@ss uk-margin-left uk-margin-right">
							<span class="uk-label tdactor_label uk-width-expand">選択中のクリップ、もしくはターゲットトラックにあるソーステキストを対象とします</span>
							<button class="uk-button uk-button-secondary uk-width-expand uk-margin-bottom" onClick="autoNewLine_ExecuteButton()">実行</button>
						</div>
					</li>
					<li>
						<div class='uk-flex-center uk-child-width-expand@ss uk-margin-left uk-margin-right' id="overwriteclip_trigger_root">
							<div class="uk-flex uk-flex-left uk-margin-small-top uk-margin-remove-bottom">
								<span class="uk-label tdactor_label uk-width-expand">アクティブシーケンスのターゲットオーディオトラックにあるクリップをトリガーの対象とします</span>
							</div>	
							<div class="uk-flex uk-flex-left uk-margin-remove-top">
								<span class="uk-label tdactor_label uk-width-auto">トリガー：クリップの開始</span>
							</div>
							<div class="uk-flex-center uk-margin-left uk-margin-remove-vertical uk-flex-nowrap" uk-grid>
								<button category="trigger_clip_override" id="trigger_clipstart_clippath" class="uk-button uk-button-secondary uk-width-large uk-margin-small uk-margin-left uk-margin-remove-bottom uppercase_disable text_ellipsis get_select_project_clip">選択中のクリップをセット</button>
								<div class="uk-flex uk-flex-middle uk-width-auto insert_mode uk-margin-small-top uk-flex-nowrap" uk-grid>
									<div category="trigger_clip_override" id="trgclp_str_ins_in" class="triggerclip_insert_setting insert_setting_icon insert_inpoint enable" style="padding-left:15px; padding-right:15px"> 
										<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 100 100" style="enable-background:new 0 0 100 100;" xml:space="preserve"><g><line class="insert_inpoint1" x1="2.6" y1="50.5" x2="53.1" y2="50.5"/><g><line class="insert_inpoint1" x1="2.6" y1="50.5" x2="34.1" y2="50.5"/><g><polygon class="insert_inpoint1" points="30.2,63.8 53.1,50.5 30.2,37.2 "/></g></g></g><rect x="56.2" y="9" class="insert_inpoint2" width="40.7" height="83.8"/><polygon class="insert_inpoint1" points="77.7,9 56.2,31.8 56.2,92.8 96.8,92.8 96.8,9 "/></svg>
									</div>
									<div category="trigger_clip_override" id="trgclp_str_ins_out" class="triggerclip_insert_setting insert_setting_icon insert_outpoint disable" style="padding-left:15px; padding-right:15px">
										<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 100 100" style="enable-background:new 0 0 100 100;" xml:space="preserve"><polygon class="insert_outpoint4" points="14.3,92.8 85.8,92.8 85.8,9 14.2,9 "/><polygon class="insert_outpoint1" points="64.3,9 85.8,31.8 85.8,92.8 14.3,92.8 14.2,9 "/><g><line class="insert_outpoint3" x1="31.1" y1="50" x2="81.6" y2="50"/><g><line class="insert_outpoint3" x1="31.1" y1="50" x2="62.6" y2="50"/><g><polygon class="insert_outpoint3" points="58.7,63.3 81.6,50 58.7,36.7 "/></g></g></g></svg>
									</div>
									<div category="trigger_clip_override" id="trgclp_str_ins_mkr" class="triggerclip_insert_setting insert_setting_icon insert_marker disable" style="padding-left:15px; padding-right:15px">
										<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 100 100" style="enable-background:new 0 0 100 100;" xml:space="preserve"><polygon class="marker_icon" points="23.1,58.425 23.1,18 76.57,18 76.57,58.425 49.535,83 23.1,58.425 "/></svg>
									</div>
									<div class="triggerclip_insert_setting insert_setting_icon trigger_clip_trash" style="padding-left:15px; padding-right:15px">
										<a href="#" class="icon_s" uk-icon="icon: trash"></a>
									</div>
								</div>
							</div>
							<div class="uk-flex uk-flex-left uk-margin-small-top">
								<span class="uk-label  tdactor_label uk-width-auto">トリガー：クリップの終了</span>
							</div>
							<div class="uk-flex-center uk-margin-left uk-margin-remove-vertical uk-flex-nowrap" uk-grid>
								<button category="trigger_clip_override" id="trigger_clipend_clippath" class="uk-button uk-button-secondary uk-width-large uk-margin-small uk-margin-left uk-margin-remove-bottom uppercase_disable text_ellipsis get_select_project_clip">選択中のクリップをセット</button>
								<div class="uk-flex uk-flex-middle uk-width-auto insert_mode uk-margin-small-top uk-flex-nowrap" uk-grid>
									<div category="trigger_clip_override" id="trgclp_end_ins_in" class="triggerclip_insert_setting insert_setting_icon insert_inpoint enable" style="padding-left:15px; padding-right:15px"> 
										<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 100 100" style="enable-background:new 0 0 100 100;" xml:space="preserve"><g><line class="insert_inpoint1" x1="2.6" y1="50.5" x2="53.1" y2="50.5"/><g><line class="insert_inpoint1" x1="2.6" y1="50.5" x2="34.1" y2="50.5"/><g><polygon class="insert_inpoint1" points="30.2,63.8 53.1,50.5 30.2,37.2 "/></g></g></g><rect x="56.2" y="9" class="insert_inpoint2" width="40.7" height="83.8"/><polygon class="insert_inpoint1" points="77.7,9 56.2,31.8 56.2,92.8 96.8,92.8 96.8,9 "/></svg>
									</div>
									<div category="trigger_clip_override" id="trgclp_end_ins_out" class="triggerclip_insert_setting insert_setting_icon insert_outpoint disable" style="padding-left:15px; padding-right:15px">
										<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 100 100" style="enable-background:new 0 0 100 100;" xml:space="preserve"><polygon class="insert_outpoint4" points="14.3,92.8 85.8,92.8 85.8,9 14.2,9 "/><polygon class="insert_outpoint1" points="64.3,9 85.8,31.8 85.8,92.8 14.3,92.8 14.2,9 "/><g><line class="insert_outpoint3" x1="31.1" y1="50" x2="81.6" y2="50"/><g><line class="insert_outpoint3" x1="31.1" y1="50" x2="62.6" y2="50"/><g><polygon class="insert_outpoint3" points="58.7,63.3 81.6,50 58.7,36.7 "/></g></g></g></svg>
									</div>
									<div category="trigger_clip_override" id="trgclp_end_ins_mkr" class="triggerclip_insert_setting insert_setting_icon insert_marker disable" style="padding-left:15px; padding-right:15px">
										<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 100 100" style="enable-background:new 0 0 100 100;" xml:space="preserve"><polygon class="marker_icon" points="23.1,58.425 23.1,18 76.57,18 76.57,58.425 49.535,83 23.1,58.425 "/></svg>
									</div>
									<div class="triggerclip_insert_setting insert_setting_icon trigger_clip_trash" style="padding-left:15px; padding-right:15px">
										<a href="#" class="icon_s" uk-icon="icon: trash"></a>
									</div>
								</div>
							</div>
						</div>
						<div class="uk-flex uk-flex-left uk-margin-small-top uk-margin-left">
							<span class="uk-label uk-width-auto tdactor_label">クリップをオーバーライトするトラックの選択</span>
						</div>
						<div class="uk-flex-center uk-child-width-expand@ss uk-margin-left uk-margin-right" uk-grid>
							<select class="tdactor_selectbox uk-margin-small-left uk-width-expand uk-select save_setting_value_on_change" category="trigger_clip_override" id="trigger_clip_override_target_seq" type="selectbox">
								<option value="0">選択中のシーケンス</option>
								<option value="1">アクティブシーケンス</option>
							</select>
							<select class="tdactor_selectbox uk-margin-small-left uk-width-auto uk-select save_setting_value_on_change" category="trigger_clip_override" id="trigger_clip_override_target_track" type="selectbox">
								<option value="0">Video Track</option>
							</select>
						</div>
						<div class="uk-flex uk-flex-center uk-margin-top uk-margin-left uk-margin-right">
							<button class="uk-button uk-button-secondary uk-width-expand uk-margin-bottom" onclick="triggerOverriteClip_ExecuteButton()">実行</button>
						</div>
					</li>
				</ul>
			</li>
			<li>
				<div class="uk-thumbnav td-thumbnav uk-padding uk-padding-small uk-padding-remove-vertical actor_linknav">
					<ul></ul>
				</div>
				<ul class="uk-switcher" id="actor_switcher"></ul>
			</li>
			<li>
				<div class='uk-margin-small' id='actor_controle_div'>
					<select class="tdactor_selectbox uk-margin-small-left uk-width-expand uk-select" name="select_actor" id="select_actor_setting"></select>
					<div class="uk-flex-center uk-child-width-expand@ss uk-margin-small-top uk-margin-left uk-margin-right actor_setting_control" uk-grid>
						<button class="uk-button uk-button-secondary uk-button-small uk-margin-small-left uk-margin-small-right" id="actor_setting_start" onClick="actorSettingStart()">設定開始</button>
						<button class="uk-button uk-button-secondary uk-button-small uk-margin-small-left uk-margin-small-right disable" id="actor_setting_save_button" onClick="OverwriteActorStructure()">保存</button>
						<button class="uk-button uk-button-secondary uk-button-small uk-margin-small-left uk-margin-small-right disable" id="actor_setting_initialize" onClick="InitializeActorStructure()">初期化</button>
					</div>
				</div>
				<div class="uk-child-width-1-2" uk-grid id="actor_setup">
					<div>
						<ul uk-nav class="uk-light uk-nav-default uk-background-secondary uk-width-auto uk-padding">
							<div class="root_container" id="root_container"></div>
							<details class="container" id=actor_not_use>
								<summary>Not use</summary>
							</details>
							<div class="uk-margin">
								<div class="uk-inline uk-width-3-4">
									<span class="uk-form-icon uk-form-icon-flip" uk-icon="icon: plus"></span>
									<input class="uk-input uk-light add_container" type="text" id='add_group' placeholder="Group name...">
								</div>
							</div>
						</ul>
					</div>
					<div>
						<div style="z-index: 980;" uk-sticky="offset: 10; bottom: #top">
							<p><a href="" rel="lightbox" id="actor_setup_zoom"><img class="actor_setup_thumb" id="actor_setup_thumb" src="" alt=""/></a></p>
						</div>
					</div>
				</div>
			</li>
			<li>
				<div class="uk-flex-center uk-child-width-expand@ss uk-margin-left uk-margin-right ">
					<span class="uk-label tdactor_label uk-margin-remove-bottom uppercase_disable">wav, mp3, wmvファイルが作成された際に指定のビンにインポートし、指定のトラックに並べます</span>
					<span class="uk-label tdactor_label">設定は監視を開始したとき、またはルールを削除したときに保存されます</span>
				</div>
				<div class="uk-flex-center uk-child-width-expand@ss uk-margin-left uk-margin-right" id="auto_import_root">
				</div>
				<div class="uk-flex-center uk-child-width-expand@ss uk-margin-left uk-margin-right">
					<button class="uk-button uk-button-secondary uk-width-expand add_watch_dir uk-margin-bottom" onClick="addAutoImportWatchDir()">監視フォルダの追加</button>
				</div>
			</li>
		</ul>
	</div>
</body>

<script>
	const newLineReg = /\r\n|\n|\r/g;
	const asciiReg = /[a-zA-Z0-9!-/:-@¥[-`{-~ ]/g;
	const fs = require('fs');
	const chokidar = require('chokidar');
	const SettingApplyEvent = new CustomEvent('setting_apply');
	let CustomInitialize = {};
	let CEP_ERROR_TO_MESSAGE = {};
	CEP_ERROR_TO_MESSAGE[window.cep.fs.NO_ERROR] = "No error";
	CEP_ERROR_TO_MESSAGE[window.cep.fs.ERR_UNKNOWN] = "[error] Unknown error occurred.";
	CEP_ERROR_TO_MESSAGE[window.cep.fs.ERR_INVALID_PARAMS] = "[error] Invalid parameters passed to function.";
	CEP_ERROR_TO_MESSAGE[window.cep.fs.ERR_NOT_FOUND] = "[error] File or directory was not found.";
	CEP_ERROR_TO_MESSAGE[window.cep.fs.ERR_CANT_READ] = "[error] File or directory could not be read.";
	CEP_ERROR_TO_MESSAGE[window.cep.fs.ERR_UNSUPPORTED_ENCODING] = "[error] An unsupported encoding value was specified.";
	CEP_ERROR_TO_MESSAGE[window.cep.fs.ERR_CANT_WRITE] = "[error] File could not be written.";
	CEP_ERROR_TO_MESSAGE[window.cep.fs.ERR_OUT_OF_SPACE] = "[error] Target directory is out of space. File could not be written.";
	CEP_ERROR_TO_MESSAGE[window.cep.fs.ERR_NOT_FILE] = "[error] Specified path does not point to a file.";
	CEP_ERROR_TO_MESSAGE[window.cep.fs.ERR_NOT_DIRECTORY] = "[error] Specified path does not point to a directory.";
	CEP_ERROR_TO_MESSAGE[window.cep.fs.ERR_FILE_EXISTS] = "[error] Specified file already exists.";
	CEP_ERROR_TO_MESSAGE[window.cep.fs.ERR_EXCEED_MAX_NUM_PROCESS] = "[error]  The maximum number of processes has been exceeded.";
	CEP_ERROR_TO_MESSAGE[window.cep.fs.ERR_INVALID_URL] = "[error] Invalid URL.";
	CEP_ERROR_TO_MESSAGE[window.cep.fs.DEPRECATED_API] = "[error] deprecated API.";

	let audioTrackSelectBox = [];
	let videoTrackSelectBox = [];
	let watcherId = 0;
	let watcherList = [];
	let importPathBuffer = [];
	let importTrackBuffer = [];
	let importBinBuffer = [];
	let importExecuteId = null;
	let ExtensionSettings = {};
	let ExtensionSettingsFilePath = null;
	let SetectedProjectItemTreePath = '';

	function autoImportStart(dirPath, matchingPatternList, matchingSourceList, importBinList, trackList) {
		const _matchingPatternList = matchingPatternList;
		const _matchingSourceList = matchingSourceList;
		const _importBinList = importBinList;
		const _trackList = trackList;
		let watcher = null;
		if(dirPath.lastIndexOf('/') != dirPath.length - 1) {
			dirPath += '/';
		}
		watcher = chokidar.watch(dirPath + '*.{wav,mp3,wmv}', {
			persistent:true,
			ignoreInitial:true,
			depth:0
		}).on('add', (path, stat) => {
			const filename = path.substr(path.lastIndexOf('/') + 1);
			const length = _matchingSourceList.length;
			for(let i = 0; i < length; i++) {
				let match = false;
				let text = null;
				if(_matchingSourceList[i] == 1) {
					const txt_filnename = path.slice(0, path.lastIndexOf('.') + 1) + 'txt';
					text = getJSISText(txt_filnename);
				} else {
					text = filename;
				}
				if(text != null) {
					const reg = new RegExp(_matchingPatternList[i]);
					if(text.search(reg) != -1) {
						if(importExecuteId != null) {
							clearTimeout(importExecuteId);
						}
						importPathBuffer.push(path.replace(/\\/g, '/'));
						importTrackBuffer.push(_trackList[i] - 1);
						importBinBuffer.push(_importBinList[i]);
						importExecuteId = setTimeout(importExecute, 500);
						break;
					}
				}
			}
		});
		watcherId++;
		watcherList[watcherId] = watcher;
		return watcherId;
	}

	function importExecute() {
		const csInterface = new CSInterface();
		csInterface.evalScript('$._PPP_.importFiles("' + importPathBuffer.join('\\\\') + '","' + importTrackBuffer.join('\\\\') + '","' + importBinBuffer.join('\\\\') + '")');
		importPathBuffer = [];
		importTrackBuffer = [];
		importBinBuffer = [];
		importExecuteId = null;
	}

	function autoImportStop (id) {
		watcherList[id].close();
	}

	function addAutoImportWatchDir() {
		let watch_div =  $('<div>', {'class':'watch_dir_element'});
		let path_input = $('<input>', {'class':'uk-input uk-margin-large-left uk-padding-small uk-light uk-width-expand tdinput auto_import_dir_path' ,'type':'text', placeholder:'監視フォルダのパス'});
			path_input[0].addEventListener('change', function(e) {
				e.target.value = e.target.value.replace(/\\/g, '/');
				if(fs.existsSync(e.target.value)) {
					e.target.classList.remove('tdact_setting_error');
					e.target.classList.add('tdact_setting_ok');
				} else {
					e.target.classList.add('tdact_setting_error');
					e.target.classList.remove('tdact_setting_ok');
				}
			});
		let a1 = $('<a>', {href:'#', 'class':'uk-width-auto grid_icon' ,'uk-icon':'icon: folder'});
			a1[0].addEventListener('click', function(e) {
				let watch_dir = window.cep.fs.showOpenDialogEx(false, true, '監視フォルダの選択', null).data;
				if(watch_dir == '') return;
				const pathInput = $(e.target).closest('a').prevAll('input');
				pathInput.val(watch_dir[0]);
				pathInput.removeClass('tdact_setting_error');
				pathInput.addClass('tdact_setting_ok');
			});
		let a2 = $('<a>', {href:'#', 'class':'uk-width-auto grid_icon' ,'uk-icon':'icon: link'});
			a2[0].addEventListener('click', function(e) {
				const target = $(e.target).closest('a');
				const elm = target.closest('.watch_dir_element');
				if(target.hasClass('tdact_setting_ok')) {
					autoImportStop(target.val());
					target.removeClass('tdact_setting_ok');
					elm.find('*').each(function(i, o) { 
						$(o).removeClass('events_disable');
					}); 
				} else {
					const dirPathInput = elm.find('.auto_import_dir_path');
					const dirPath = dirPathInput.val();
					const body = elm.find('tbody');

					let invalid = false;
					if(!fs.existsSync(dirPath)) {
						dirPathInput.addClass('tdact_setting_error');
						invalid = true;
					}
					body.find('.auto_import_bin').each(function(i, o) { 
						const bin_button = $(o);
						if(!bin_button.hasClass('tdact_setting_ok')) {
							bin_button.addClass('tdact_setting_error');
							invalid = true;
						} else {
							bin_button.removeClass('tdact_setting_error');							
						}
					}); 
					body.find('.auto_import_matching_pattern').each(function(i, o) { 
						const matching_pattern = $(o);
						if(matching_pattern.val() == '') {
							matching_pattern.addClass('tdact_setting_error');
							invalid = true;
						} else {
							matching_pattern.removeClass('tdact_setting_error');
							matching_pattern.addClass('tdact_setting_ok');
						}
					});

					body.find('.auto_import_track_selector').each(function(i, o) { 
						const track_selector = $(o);
						if(track_selector.hasClass('tdact_setting_error')) {
							invalid = true;
						}
					});

					if(invalid) return;
					const matchingPatternList = [];
					body.find('.auto_import_matching_pattern').each(function(i, o) { matchingPatternList.push($(o).val()); });
					const matchingSourceList = [];
					body.find('.auto_import_source').each(function(i, o) { matchingSourceList.push($(o).val()); });
					const importBinList = [];
					body.find('.auto_import_bin').each(function(i, o) { importBinList.push($(o).html()); });
					const trackList = [];
					body.find('.auto_import_track_selector').each(function(i, o) { trackList.push($(o).val()); });

					const id = autoImportStart(dirPath, matchingPatternList, matchingSourceList, importBinList, trackList);				
					target.val(id);
					target.addClass('tdact_setting_ok');
					elm.find('table').each(function(i, o) { 
						$(o).addClass('events_disable');
					});
					elm.find('.auto_import_add_rule_button').addClass('events_disable');
					const head = elm.children().eq(0);
					head.find('a').each(function(i, o) { 
						$(o).addClass('events_disable');
					});
					head.find('input').each(function(i, o) { 
						$(o).addClass('events_disable');
					});
					target.removeClass('events_disable');
					SaveAutoImportSettings();
				}
			});
		let a3 = $('<a>', {href:'#', 'class':'uk-width-auto grid_icon' ,'uk-icon':'icon: trash'});
			a3[0].addEventListener('click', function(e) {
				if(!confirm('この監視フォルダ設定を削除しますか？')){
					return false;
				} else {
					$(e.target).closest('.watch_dir_element').remove();
					SaveAutoImportSettings();
				}
			});
		let path_div =  $('<div>', {'class':'uk-grid uk-grid-match uk-child-width-auto@ss'});
			path_div.append(path_input);
			path_div.append(a1);
			path_div.append(a2);
			path_div.append(a3);
		watch_div.append(path_div);

		let body = $('<tbody>');
		let table = $('<table>', {'class':'uk-table uk-table-small uk-table-middle uk-table-justify'});
			table.append(body);
		
		let button = $('<button>', {'class':'uk-button uk-button-secondary uk-width-auto uk-flex uk-flex-center auto_import_add_rule_button'});
			button.html('ルール追加');
			button[0].addEventListener('click', function(e) {
				let parent = $(e.target.parentNode);
				let tbody = parent.prev('table').children('tbody');
				addAutoImportRule(tbody);
			});
		let add_rule_div = $('<div>', {'class':'uk-flex uk-flex-center'});
			add_rule_div.append(button);
		let table_div = $('<div>', {'class':'uk-overflow-auto uk-margin-left'});
			table_div.append(table);
			table_div.append(add_rule_div);
		watch_div.append(table_div);
		watch_div.append($('<hr>'));

		let ai_root = $("#auto_import_root");
			ai_root.append(watch_div);

		return watch_div;
	}

	function addAutoImportRule(jqTbody) {
		let select1 = $('<select>', {'class':'tdactor_selectbox uk-width-auto uk-select auto_import_source'});
			let s1_option1 = $('<option>', {value:'1'})
				s1_option1.html('.txt内容');
			let s1_option2 = $('<option>', {value:'2'})
				s1_option2.html('ファイル名');
			select1.append(s1_option1);
			select1.append(s1_option2);
		let td1 = $('<td>', {'class':'uk-text-nowrap uk-table-shrink'});
			td1.append(select1);
		
		let button1 = $('<button>', {'class':'uk-button uk-button-secondary uppercase_disable text_ellipsis uk-padding-small uk-padding-remove-vertical auto_import_bin'});
			button1.html('選択中のビンをセット');
			button1[0].addEventListener('click', function(e) {
				const treePath = SetectedProjectItemTreePath;
				var csInterface = new CSInterface();
				csInterface.evalScript('$._PPP_.existBinTreePath("' + treePath + '")', function(result) {
					if(result) {
						e.target.innerHTML = treePath;
						e.target.setAttribute('uk-tooltip', treePath);
						e.target.classList.add('tdact_setting_ok');
						e.target.classList.remove('tdact_setting_error');
					}
				});
			});
		let td2 = $('<td>', {'class':'uk-text-nowrap uk-table-shrink'});
			td2.append(button1);
		let select2 = $('<select>', {'class':'tdactor_selectbox uk-width-auto uk-select auto_import_track_selector'});
			let s2_option = $('<option>', {value:"0"})
			s2_option.html('トラック番号');
			select2.append(s2_option);
			select2[0].addEventListener('change', function(e) {
				const selectbox = $(e.target);
				const max_value = Number(selectbox.attr('max_track_num'));
				if(max_value && Number(selectbox.val()) > max_value) {
					selectbox.removeClass('tdact_setting_ok');
					selectbox.addClass('tdact_setting_error');
					selectbox.attr('uk-tooltip', max_value + ' 以下を選択してください');
				} else {
					selectbox.removeClass('tdact_setting_error');
					selectbox.addClass('tdact_setting_ok');
					selectbox.removeAttr('uk-tooltip');
				}
			});
			audioTrackSelectBox.push(select2);

			const csInterface = new CSInterface();
			csInterface.evalScript('$._PPP_.sequenceStructureChanged()');
		let td3 = $('<td>', {'class':'uk-text-nowrap uk-table-shrink'});
			td3.append(select2);
		let input = $('<input>', {'class':'uk-input uk-light tdinput auto_import_matching_pattern', type:'text', placeholder:'マッチングパターン'});
			input[0].addEventListener('change', function(e) {
				e.target.classList.remove('tdact_setting_ok');
				e.target.classList.remove('tdact_setting_error');
			});
		let td4 = $('<td>', {'class':'uk-text-nowrap'});
			td4.append(input);
		let a = $('<a>', {href:'#', 'class':'icon_s', 'uk-icon':'icon: trash'})
		let td5 = $('<td>', {'class':'uk-text-nowrap'});
			td5.append(a);
			td5[0].addEventListener('click', function(e) {
				if(!confirm('振り分けルールを削除しますか？')){
					return false;
				} else {
					const target_tr = $(e.target).closest('tr');
					const track_selector = target_tr.find('.auto_import_track_selector');
					const length = audioTrackSelectBox.length;
					for(let i = 0; i < length; i++){
						if(track_selector.is(audioTrackSelectBox[i])) {
							audioTrackSelectBox.splice(i, 1);
							break;
						}
					}
					$(e.target).closest('tr').remove();
					SaveAutoImportSettings();
				}
			});

		let tr = $('<tr>');
			tr.append(td4);
			tr.append(td1);
			tr.append(td2);
			tr.append(td3);
			tr.append(td5);
		jqTbody.append(tr);
		return tr;
	}

	let ActorStructure = [];
	lightbox.option({
		'resizeDuration': 400,
		'fadeDuration':200,
		'imageFadeDuration':200
	})

	$(function(){
		SortableSet();

		$(document).on('click', '.propertyDeploy>div>div', function(e){
			if($(this).hasClass('enable')) {
				if(e.shiftKey) {
					$(this).parents('details').find('div').removeClass('enable');
				} else {
					$(this).removeClass('enable');
					$(this).siblings().removeClass('enable');
				}
			} else {
				if(e.shiftKey) {
					$(this).parents('details').find('div').addClass('enable');
				} else {
					$(this).siblings().addClass('enable');
					$(this).addClass('enable');
				}
			}
		});

		$(document).on('click', '.dragitem', function() {
			var path = $(this).attr('src');
			var thumb = $('#actor_setup_thumb');
			thumb.attr('src', path);
			transparent_crop_async(path, setupCropImageSet);
		});

		$(document).on('click', '.actor_sequence_link.unlink', function() {
			var index = $(this).attr('sequence');
			var actorName = $(this).children('.actor_sequence_link_label').html();
			var actor_sequence_link = $(this);
			var actor_sequence_link_icon = $(this).find('.actor_sequence_link_icon');
			$('.actor_sequence_link').removeClass('enable');
			$('#actor_switcher').find('li').removeClass('uk-active');
			var target_actor_component = $('#actor_switcher').find("[sequence='" + index + "']");
			var actor_root = $('.actor_component[sequence="' + index + '"]');
			
			var csInterface = new CSInterface();
			csInterface.evalScript('$._PPP_.getActorStructureMediaPath("' + actorName + '")', function(actorStructPath) {
				if(actorStructPath === '') {
					alert("構成ファイルが見つかりません。立ち絵設定を行ってください");
					var function_switch = $('#function_switch').children('li');
					var actor_functions = $('#actor_functions').children('li');
					function_switch.eq(2).removeClass('uk-active');
					actor_functions.eq(2).removeClass('uk-active');
					function_switch.eq(3).addClass('uk-active');
					actor_functions.eq(3).addClass('uk-active');
					document.getElementById('select_actor_setting').selectedIndex = index;
					actorSettingStart();
				} else {
					csInterface.evalScript('$._PPP_.setLinkSequence("' + index + '")', function(result) {
						if(result === '0') {
							actor_sequence_link.addClass('enable');
							actor_sequence_link.removeClass('unlink');
							actor_sequence_link.addClass('linked');
							actor_sequence_link_icon.attr('uk-icon', 'link');
							target_actor_component.addClass('uk-active');
							actor_root.empty();

							SetupActorComponent(index, actorName);
						} else {
							var errormsg = 'Error : ';
							switch(result){
								case '1':
									errormsg += 'アクティブシーケンスがありません';
									break;
								case '2':
									errormsg += 'クリップが選択されていません';
									break;
								case '3':
									errormsg += '複数のクリップを選択してます';
									break;
								case '4':
									errormsg += 'シーケンスが選択されていません';
									break;
								default:
									errormsg += 'Unknown';
									break;
							}
							if(result !== '2') {
								alert(errormsg);
							} else {
								if(!confirm(errormsg + '\nシーケンスを作成しますか？')){
									return false;
								} else {
									csInterface.evalScript('$._PPP_.getActorStructureMediaPath("' + actorName + '")', function(result) {
										if(result) {
											ActorStructure[index] = LoadActorStructure(result);
											if(ActorStructure[index]) {
												var treePath = '';
												for(var i = 0; i < ActorStructure[index].actor.length - 1; i++) {
													var clips = ActorStructure[index].actor[i].clips;
													for(var j = 0; j < clips.length; j++){
														treePath = clips[j].tree_path;
														i = ActorStructure[index].actor.length;
														break;
													}
												}
												csInterface.evalScript('$._PPP_.createActorSequence("' + actorName + '","' + treePath + '")');
											}
										}
									});
								}
							}
						}
					});
				}
			});
		});

		$(document).on('click', '.actor_sequence_link.linked', function(e){
			if(e.shiftKey) {
				if(!confirm('シーケンスとのリンクを解除します')){
					return false;
				} else {
					var index = $(this).attr('sequence');
					var actor_root = $('.actor_component[sequence="' + index + '"]');
					actor_root.empty();
					$('.actor_sequence_link').removeClass('enable');
					$(this).removeClass('linked');
					$(this).addClass('unlink');
					$(this).find('.actor_sequence_link_icon').attr('uk-icon', 'ban');;
					$('#actor_switcher').find('li').removeClass('uk-active');
				}
			} else {
				$('.actor_sequence_link').removeClass('enable');
				$(this).addClass('enable');
				$('#actor_switcher').find('li').removeClass('uk-active');
				$('#actor_switcher').find('li[sequence="' + $(this).attr('sequence') + '"]').addClass('uk-active');
			}
		});

		$(document).on('click', '.insert_disable', function() {
			let lock = $(this).attr('uk-icon');
			if(lock === 'lock'){
				$(this).attr('uk-icon', 'unlock');
				$(this).parents('.actor_parts').find('.td-thumbnav').removeClass('disable');
			} else {
				$(this).attr('uk-icon', 'lock');
				$(this).parents('.actor_parts').find('.td-thumbnav').addClass('disable');
			}
		});

		$(document).on('click', '.actor_insert_setting', function() {
			enableSwitch($(this));
		});

		$(document).on('click', '.triggerclip_insert_setting', function() {
			const target = $(this);
			enableSwitch(target);
			const category = target.attr('category');
			if(category) {
				const id = target.attr('id');
				let flag = 'enable';
				if(target.hasClass('disable')) flag = 'disable';
				SettingUpdate(category, id, flag);
			}
		});

		function enableSwitch(jq_elm) {
			const enable = jq_elm.hasClass('enable');
			if(enable){
				jq_elm.addClass('disable');
				jq_elm.removeClass('enable');
			} else {
				jq_elm.addClass('enable');
				jq_elm.removeClass('disable');
			}
		}

		$(document).on('click', '.actor_thumb_parent', function() {
			var linkdActor = $('.actor_sequence_link');
			let actorName = '';
			for(var i = 0; i < linkdActor.length; i++) {
				if(linkdActor.eq(i).hasClass('enable'))
					actorName = linkdActor.eq(i).children('.actor_sequence_link_label').html();
			}
			let tree_path = $(this).attr('tree_path');
			let group_index = $(this).attr('group_index');
			let seq_index = $('.actor_linknav > ul > .enable').attr('sequence');
			let insert_mode = $(this).parents('.parts_selector');
			let flag = 0;
			if(insert_mode.find('.insert_inpoint').hasClass('enable')) flag += 1;
			if(insert_mode.find('.insert_outpoint').hasClass('enable')) flag += 2;
			if(insert_mode.find('.insert_marker').hasClass('enable')) flag += 4;
			insertActorClip(actorName, seq_index, group_index, tree_path, flag);
		});

		$(document).on('mouseenter', '.actor_thumb_parent', function() {
			let actor_label = $(this).parents('.actor_parts').find('.select_actor_label');
			actor_label.html($(this).attr('name'));
		});
		$(document).on('mouseleave ', '.actor_thumb_parent', function() {
			let actor_label = $(this).parents('.actor_parts').find('.select_actor_label');
			actor_label.html('');
		});

		$(document).on("click", ".group_trash", function(e) {
			if(!confirm('グループを削除しますか?')){
				return false;
			}else{
				let group = $(this).parents('.container');
				let child = group.children('.dragitem');
				group.children('.dragitem').appendTo($('#actor_not_use'));
				group.remove();
			}
		});

		$('#select_actor_setting').on('change', function(e) {
			$('#actor_setting_save_button').addClass('disable');
			$('#actor_setting_initialize').addClass('disable');
			clearActorSettingPanel();
		});

		$(document).on('change', '#preset_tag', function() {
			const time = 60*60*24*30*6;
			document.cookie = 'presettag=' + encodeURIComponent($('#preset_tag').val()) + ';max-age=' + time;
		});

		$(document).on('click', '.merker_color_selector', function() {
			const target = $(this);
			target.siblings('.merker_color_selector').each(function(index, element){
				$(element).removeClass('merker_color_selected');
				$(element).empty();
			});
			if(!target.hasClass('merker_color_selected')) {
				target.addClass('merker_color_selected');
				target.append($('<div>', {'uk-icon':'icon: check; ratio:1.5', style:'color:#232323'}))
			}
			const parent = target.parent();
			const category = parent.attr('category');
			const id = parent.attr('id');
			const value = parent.children().index(target);
			SettingUpdate(category, id, value);
		});

		$('#trigger_clip_override_target_seq').on('change', function() {
			let target = $(this);
			const trackNumSelectbox = $('#trigger_clip_override_target_track');
			if(target.val() === '1') {
				videoTrackSelectBox.push($('#trigger_clip_override_target_track'));
				const csInterface = new CSInterface();
				csInterface.evalScript('$._PPP_.sequenceStructureChanged()');
			} else {
				const length = videoTrackSelectBox.length;
				for(let i = 0; i < length; i++){
					if(target.is(videoTrackSelectBox[i])) {
						videoTrackSelectBox.splice(i, 1);
						break;
					}
				}
				if(Number(trackNumSelectbox.attr('max_track_num')) < Number(trackNumSelectbox.attr('select_seq_track'))) {
					trackNumSelectbox.attr('max_track_num', trackNumSelectbox.attr('select_seq_track'));
				};
			}
			const videoTrackNum = trackNumSelectbox.attr('select_seq_track');
			if(videoTrackNum != null && trackNumSelectbox.val() <= videoTrackNum && trackNumSelectbox.val() > 0) {
				trackNumSelectbox.removeClass('tdact_setting_error');
				trackNumSelectbox.addClass('tdact_setting_ok');
				trackNumSelectbox.removeAttr('uk-tooltip');
				trackNumSelectbox.removeAttr('max_track_num');
				while(trackNumSelectbox.children().length - 1 > videoTrackNum) {
					trackNumSelectbox.children().last().remove();
				}
				let value = trackNumSelectbox.children().length;
				while(trackNumSelectbox.children().length <= videoTrackNum) {
					const op = $('<option>', {'value':value});
					op.html(value);
					trackNumSelectbox.append(op);
					value += 1;
				}
			} else {
				trackNumSelectbox.removeClass('tdact_setting_ok');
				trackNumSelectbox.addClass('tdact_setting_error');
				if(videoTrackNum != undefined) {
					trackNumSelectbox.attr('uk-tooltip', videoTrackNum + ' 以下を選択してください');
					trackNumSelectbox.attr('max_track_num', videoTrackNum);
				} else {
					trackNumSelectbox.attr('uk-tooltip', 'シーケンスを選択してください');
					trackNumSelectbox.attr('max_track_num', 1);
				}
			}
		});

		$('#trigger_clip_override_target_track').on('change', function() {
			const selectbox = $(this);
			const max_value = Number(selectbox.attr('max_track_num'));
			const select_value = Number(selectbox.val());
			if(max_value && select_value > max_value || select_value === 0) {
				selectbox.removeClass('tdact_setting_ok');
				selectbox.addClass('tdact_setting_error');
				if(select_value === 0) {
					selectbox.attr('uk-tooltip', '1 以上を選択してください');
				} else {	
					selectbox.attr('uk-tooltip', max_value + ' 以下を選択してください');
				}
			} else {
				selectbox.removeClass('tdact_setting_error');
				selectbox.addClass('tdact_setting_ok');
				selectbox.removeAttr(' uk-tooltip');
			}
		});

		$(document).on('click', '.get_select_project_clip', function() {
			const target = $(this);
			const treePath = SetectedProjectItemTreePath;
			const csInterface = new CSInterface();
			csInterface.evalScript('$._PPP_.existClipTreePath("' + treePath + '")', function(result) {
				if(result) {
					target.html(treePath);
					target.attr('uk-tooltip', treePath);
					target.addClass('tdact_setting_ok');
					target.removeClass('tdact_setting_error');
					const category = target.attr('category');
					const id = target.attr('id');
					SettingUpdate(category, id, treePath);
				}
			});
		});

		$(document).on('click', '.trigger_clip_trash', function() {
			const treePathButton = $(this).parent().prev();
			treePathButton.html('選択中のクリップをセット');
			treePathButton.removeAttr('uk-tooltip');
			treePathButton.removeClass('tdact_setting_ok');
			treePathButton.removeClass('tdact_setting_error');
			const category = treePathButton.attr('category');
			const id = treePathButton.attr('id');
			SettingUpdate(category, id, treePathButton.html());	
		});
		

		$(document).on('change', '.input_num_only', function() {
			let target = $(this);
			let inputval = target.val().match(/[0-9０-９]+/g);
			if(inputval) {
				inputval = inputval.join('').replace(/[０-９]/g, function(s) {
					return String.fromCharCode(s.charCodeAt(0) - 0xFEE0);
				});
				target.val(inputval);
			} else {
				target.val('');
			}
		});

		$('#subtitle_replace_flag').on('change', function() {
			const val = $(this).val().match(/[gimuys]+/);
			if(val) {
				$(this).val(val.join(''));
			} else {
				$(this).val('');
			}
		});

		$(document).on('change', '.save_setting_value_on_change', function() {
			SaveSettingValueFromElement($(this));
		});
		$(document).on('change', '.save_setting_check_on_change', function() {
			SaveSettingCheckFromElement($(this));
		});

	});

	function propertyCapture() {
		var csInterface = new CSInterface();
		csInterface.evalScript('$._PPP_.captureSelectedClipProperties()', function(propertiesNames) {
			$('#capturedParameters').empty();
			var obj = JSON.parse(propertiesNames);
			for(let i = 0; i < obj.components.length; i++) {
				var componentName = $('<details>', {'class':'propertyDeploy', open:true});
				var summary = $('<summary>');
					summary.html(obj.components[i].componentName);
				componentName.append(summary);
				const properties = obj.components[i].properties;
				for(let j = 0; j < properties.length; j++) {
					if(properties[j].name !== ' ' && properties[j].name !== 'textEditValue' &&  properties[j].name !== 'fontTextRunLength') {
						var grid = $('<div>', {'class':'uk-flex uk-text-left uk-padding-remove-left uk-grid uk-grid-stack uk-margin-remove-top deploy_property_select', 'uk-grid':''});
						var icon = $('<div>', {'class':'uk-padding-remove-left uk-icon', 'uk-icon': 'icon: check'})
						var prop = $('<div>', {'class':'uk-padding-remove-left uk-width-expand property_name'});
							prop.html(properties[j].name);
						grid.append(icon);
						grid.append(prop);
						componentName.append(grid);
					}
				}
				$('#capturedParameters').append(componentName);
			}
		});
	}

	function propertyDeploy() {
		let componentList = [];
		let capturedParameters = $('#capturedParameters>.propertyDeploy');
		for(let i = 0; i < capturedParameters.length; i++){
			const component = capturedParameters.eq(i);
			var propertyNames = {componentName: component.children('summary').html(), properties : []};
			let properties = component.children('.deploy_property_select');
			for(let j = 0; j < properties.length; j++) {
				if(properties.eq(j).children('.property_name').hasClass('enable')) {
					propertyNames.properties.push(properties.eq(j).children('.property_name').html());
				}
			}
			componentList.push(propertyNames);
		}
		let wrapper = {components:componentList};

		var csInterface = new CSInterface();
		csInterface.evalScript('$._PPP_.deployCapturedProperties(' + JSON.stringify(wrapper) + ')');
	}

	document.body.addEventListener('keydown', function(e) {
		if($('#function_actor').hasClass('uk-active')) {
			var csInterface = new CSInterface();
			if (e.key === 'ArrowLeft') {
				var linkdActor = $('.actor_sequence_link.linked');
				for(var i = linkdActor.length - 1; i >= 0; i--) {
					if(linkdActor.eq(i).hasClass('enable')) {
						if(i - 1 >= 0) {
							linkdActor.eq(i - 1).click();
						}
						break;
					}
				}
				e.preventDefault();
			} else if (e.key === 'ArrowRight') {
				var linkdActor = $('.actor_sequence_link.linked');
				for(var i = 0; i < linkdActor.length; i++) {
					if(linkdActor.eq(i).hasClass('enable')) {
						if(i + 1 < linkdActor.length) {
							linkdActor.eq(i + 1).click();
						}
						break;
					}
				}
				e.preventDefault();
			} else if (e.key === 'ArrowUp') {
				csInterface.evalScript('$._PPP_.prevEditPoint()');
				e.preventDefault();
			} else if (e.key === 'ArrowDown') {
				csInterface.evalScript('$._PPP_.nextEditPoint()');
				e.preventDefault();
			} else if((e.key >= '0' && e.key <= '9') || (e.key >= 'a' && e.key <= 'z')){
				if(e.ctrlKey) {
					getActorClipSet(e.key);
				} else {
					setActorClipSet(e.key);
				}
				e.preventDefault();
			} 
		}
	}, {passive: false});

	function loadSetup() {
		var csInterface = new CSInterface();
		var extPath = csInterface.getSystemPath(SystemPath.EXTENSION);
		csInterface.evalScript('$._PPP_.Setup("' + extPath + '")');

		csInterface.addEventListener('numTracksNotification', function(e) {
			trackNum = e.data.split(',');
			const audioTrackNum = Number(trackNum[1]);
			let length = audioTrackSelectBox.length;
			for(let i = 0; i < length; i++) {
				const selectbox = audioTrackSelectBox[i];
				if(selectbox.val() <= audioTrackNum) {
					selectbox.removeClass('tdact_setting_error');
					selectbox.addClass('tdact_setting_ok');
					selectbox.removeAttr('uk-tooltip');
					selectbox.removeAttr('max_track_num');
					while(selectbox.children().length - 1 > audioTrackNum) {
						selectbox.children().last().remove();
					}
					let value = selectbox.children().length;
					while(selectbox.children().length <= audioTrackNum) {
						const op = $('<option>', {'value':value});
							op.html(value);
						selectbox.append(op);
						value += 1;
					}
				} else {
					selectbox.removeClass('tdact_setting_ok');
					selectbox.addClass('tdact_setting_error');
					selectbox.attr('uk-tooltip', trackNum[1] + ' 以下を選択してください');
					selectbox.attr('max_track_num', trackNum[1]);
				}
				selectbox.change();
			}

			const videoTrackNum = Number(trackNum[0]);
			length = videoTrackSelectBox.length;
			for(let i = 0; i < length; i++) {
				const selectbox = videoTrackSelectBox[i];
				if(selectbox.val() <= videoTrackNum) {
					selectbox.removeClass('tdact_setting_error');
					selectbox.addClass('tdact_setting_ok');
					selectbox.removeAttr('uk-tooltip');
					selectbox.removeAttr('max_track_num');
					while(selectbox.children().length - 1 > videoTrackNum) {
						selectbox.children().last().remove();
					}
					let value = selectbox.children().length;
					while(selectbox.children().length <= videoTrackNum) {
						const op = $('<option>', {'value':value});
							op.html(value);
						selectbox.append(op);
						value += 1;
					}
				} else {
					selectbox.removeClass('tdact_setting_ok');
					selectbox.addClass('tdact_setting_error');
					selectbox.attr('uk-tooltip', trackNum[0] + ' 以下を選択してください');
					selectbox.attr('max_track_num', trackNum[0]);
				}
				selectbox.change();
			}
		});

		csInterface.addEventListener('projectItemsSelect', function(e) {
			SetectedProjectItemTreePath = e.data;
		});
		csInterface.addEventListener('sequenceItemsSelectChanged', function(e) {
			const csInterface = new CSInterface();
			csInterface.evalScript('$._PPP_.getSelectedSequenceTrackNum()', function(result) {
				if(result) {
					trackNum = result.split(',');
					const videoTrackNum = Number(trackNum[0]);
					const trackNumSelectbox = $('#trigger_clip_override_target_track');
					trackNumSelectbox.attr('select_seq_track', videoTrackNum);
					if(Number($('#trigger_clip_override_target_seq').val()) === 0) {
						if(Number(trackNumSelectbox.val()) <= videoTrackNum) {
							trackNumSelectbox.removeClass('tdact_setting_error');
							trackNumSelectbox.addClass('tdact_setting_ok');
							trackNumSelectbox.removeAttr('uk-tooltip');
							trackNumSelectbox.removeAttr('max_track_num');
							while(trackNumSelectbox.children().length - 1 > videoTrackNum) {
								trackNumSelectbox.children().last().remove();
							}
							let value = trackNumSelectbox.children().length;
							while(trackNumSelectbox.children().length <= videoTrackNum) {
								const op = $('<option>', {'value':value});
								op.html(value);
								trackNumSelectbox.append(op);
								value += 1;
							}
						} else {
							trackNumSelectbox.removeClass('tdact_setting_ok');
							trackNumSelectbox.addClass('tdact_setting_error');
							trackNumSelectbox.attr('uk-tooltip', videoTrackNum + ' 以下を選択してください');
							trackNumSelectbox.attr('max_track_num', videoTrackNum);
						}
					}
					trackNumSelectbox.change();
				}
			});
		})

		var cookiesList = document.cookie.split(';');
		for(let cookie of cookiesList){
			const c = cookie.split('=');
			if( c[0] === 'presettag'){
				$('#preset_tag').val(decodeURIComponent(c[1]));
			}
		}
		const time = 60*60*24*30*6;
		document.cookie = 'presettag=' + encodeURIComponent($('#preset_tag').val()) + ';max-age=' + time;
	}

	function setActorClipSet(shortcutKey) {
		var linkdActor = $('.actor_sequence_link');
		for(var i = 0; i < linkdActor.length; i++) {
			if(linkdActor.eq(i).hasClass('enable')) {
				let seqIndex = linkdActor.eq(i).attr('sequence');
				var actorName = linkdActor.eq(i).children('.actor_sequence_link_label').html();
				let actorFlagList = $('#actor_switcher').children('[sequence=' + seqIndex + ']').find('.parts_selector');
				var treePathList = ActorStructure[seqIndex].clipset[shortcutKey].split(',');
				for(var j = 0; j < treePathList.length; j++) {
					let flag = 0;
					let insert_mode = actorFlagList.eq(actorFlagList.length - 1 - j);
					if(!insert_mode.find('.insert_disable').hasClass('enable')) {
						if(insert_mode.find('.insert_inpoint').hasClass('enable')) flag += 1;
						if(insert_mode.find('.insert_outpoint').hasClass('enable')) flag += 2;
						if(insert_mode.find('.insert_marker').hasClass('enable')) flag += 4;
						insertActorClip(actorName, seqIndex, j, treePathList[j], flag);
					}
				}
			}
		}
	}

	function getActorClipSet(shortcutKey) {
		var linkdActor = $('.actor_sequence_link');
		for(var i = 0; i < linkdActor.length; i++) {
			if(linkdActor.eq(i).hasClass('enable')) {
				let seqIndex = linkdActor.eq(i).attr('sequence');
				var actorName = linkdActor.eq(i).children('.actor_sequence_link_label').html();
				var csInterface = new CSInterface();
				csInterface.evalScript('$._PPP_.getCurrentActorClipTreePath(' + seqIndex + ',-1)', function(treePathList) {
					if(!('clipset' in ActorStructure[seqIndex])){
						ActorStructure[seqIndex].clipset = {};
					} 
					ActorStructure[seqIndex].clipset[shortcutKey] = treePathList;
					csInterface.evalScript('$._PPP_.getActorStructureMediaPath("' + actorName + '")', function(result) {
						let mediaPathList = result.split(',');
						if(result !== '' && mediaPathList.length == 1) {
							const err = SaveJson(ActorStructure[seqIndex], mediaPathList[0]);
							if(err != window.cep.fs.NO_ERROR) {
								alert(CEP_ERROR_TO_MESSAGE[err]);
							}
						}
					});
				});
				break;
			}
		}
	}

	function insertActorClip(actor_name, seq_index, group_index, tree_path, flag) {
		var csInterface = new CSInterface();
		csInterface.evalScript('$._PPP_.insertActorClip("' + actor_name + '",' + seq_index + ','+ group_index + ',"' + tree_path + '",-1,' + flag + ')');	
	}

	function SortableSet() {
		var root_container = document.querySelector('.root_container');
		new Sortable.create(root_container, {
			group: 'root',
			multiDrag: false,
			draggable: '.dragitem',
			filter: '.filtered',
			selectedClass: 'selected',
			dragClass: 'sortable-drag',
			ghostClass: 'sortable-ghost',
			animation: 150,
			fallbackOnBody: true,
			swapThreshold: 0.65,
			dragoverBubble: false});
			
		var containers = null;
		containers = document.querySelectorAll('.container');
		for (var i = 0; i < containers.length; i++) {
			new Sortable.create(containers[i], {
				group: 'nested',
				multiDrag: true,
				draggable: '.dragitem',
				filter: '.filtered',
				selectedClass: 'selected',
				dragClass: 'sortable-drag',
				ghostClass: 'sortable-ghost',
				animation: 150,
				fallbackOnBody: true,
				swapThreshold: 0.65,
				dragoverBubble: false});
		};
	}

	function AddGroup(name) {
		var summary = $('<summary>', {class:'group_label'});
		summary.html(name + ' <a href="#" class="group_trash" uk-icon="icon: trash"></a>');
		var details = $('<details>', {class:'container dragitem', group:name});
		details.append(summary);
		if($('.container.dragitem:last').length){
			$('.container.dragitem:last').after(details);
		} else {
			$('#root_container').append(details);
		}
		new Sortable.create(details[0], {
			group: 'nested',
			multiDrag: true,
			draggable: '.dragitem',
			filter: '.filtered',
			selectedClass: 'selected',
			dragClass: 'sortable-drag',
			ghostClass: 'sortable-ghost',
			animation: 150,
			fallbackOnBody: true,
			swapThreshold: 0.65,
			dragoverBubble: false,
		});
		return details;
	}

	function AddActorClip(rootNode, name, img_path, tree_path, crop_path) {
		var item = $(document.createElement('div'));
		item.addClass('dragitem');
		item.html(name);
		item.attr('clip', name);
		item.attr('tree_path', tree_path);
		item.attr('src', img_path);
		item.attr('crop_path', crop_path);
		rootNode.append(item);
	}

	function setupCropImageSet(base64) 
	{
		var zoom = $('#actor_setup_zoom');
		zoom.attr('href', base64);
	}

	function SaveNewActorStructure() {
		const path = _ActorStructureSave();
		if(path) {
			const actorName = $("#select_actor_setting").val();
			var csInterface = new CSInterface();
			csInterface.evalScript('$._PPP_.importActorStructureFile("' + path.replace(/\\/g, '/') + '","'+ actorName + '")', function(result) {
				if(!result) {
					alert('構成ファイルのインポートに失敗しました');
				}
				clearActorSettingPanel();
			});	
		}
	}

	function OverwriteActorStructure() {
		const actorName = $("#select_actor_setting").val();
		var csInterface = new CSInterface();
		csInterface.evalScript('$._PPP_.getActorStructureMediaPath("' + actorName + '")', function(result) {
			let mediaPathList = result.split(',');
			if(result !== '' && mediaPathList.length == 1) {
				var index = $(this).attr('sequence');
				var actor_root = $('.actor_component[sequence="' + index + '"]');
				actor_root.empty();

				let linklabel = $('.actor_sequence_link_label');
				for(var i = 0; i < linklabel.length; i++) {
					if(linklabel.eq(i).html() === actorName) {
						$('.actor_sequence_link').removeClass('enable');
						let root = linklabel.eq(i).parents('.actor_sequence_link');
						root.removeClass('linked');
						root.addClass('unlink');
						root.find('.actor_sequence_link_icon').attr('uk-icon', 'ban');;
						$('#actor_switcher').find('li').removeClass('uk-active');						
						break;
					}
				}

				var actor = LoadActorStructure(mediaPathList[0]);
				_ActorStructureSave(mediaPathList[0], actor);
				clearActorSettingPanel();
			}
			else {
				SaveNewActorStructure();
			}
		});	
	}

	function InitializeActorStructure() {
		if(!confirm('設定を初期化しますか？')){
			return false;
		} else {
			actorSettingStart(true);
		}
	}

	function GetUUID() {
		let uuid = "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".split("");
		let length = uuid.length;
		for (let i = 0; i < length; i++) {
			switch (uuid[i]) {
				case "x":
					uuid[i] = Math.floor(Math.random() * 16).toString(16);
					break;
				case "y":
					uuid[i] = (Math.floor(Math.random() * 4) + 8).toString(16);
					break;
			}
		}
		return uuid.join("");
	}

	function SetupActorComponent(index, actorName){
		var csInterface = new CSInterface();
		csInterface.evalScript('$._PPP_.getActorStructureMediaPath("' + actorName + '")', function(result) {
			if(result) {
				ActorStructure[index] = LoadActorStructure(result);
				var actorObj = ActorStructure[index];
				if(actorObj) {
					actor_root = $('.actor_component[sequence="' + index + '"]');
					for(var i = 0; i < actorObj.actor.length - 1; i++) {
						var actor = $('<div>', {'class':'actor_parts'});

						var label = $('<div>');
						label.attr('uk-grid', '');

						var group = $('<div>');
						group.addClass('uk-width-expand select_actor_group');
						group.html(actorObj.actor[i].group);
						label.append(group);

						var partsName = $('<div>', {'class':'uk-width-auto uk-text-right select_actor_label'});
						label.append(partsName);

						actor.append(label);


						var partsSelector = $('<div>', {'class':'uk-text-center uk-padding uk-padding-small uk-padding-remove-vertical remove-top-margine parts_selector'});
						partsSelector.attr('uk-grid', '');
						
						var checkbox_div = $('<div>', {'class':'uk-width-auto uk-height-expand insert_mode'});
						checkbox_div.append($('<div>', {'uk-icon': 'unlock', 'class': 'uk-icon actor_insert_setting insert_setting_icon insert_disable'}));
						
						let inpointClipIcon = $('<div>', {'class': 'actor_insert_setting insert_setting_icon insert_inpoint enable'});
							inpointClipIcon.html(`<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 100 100" style="enable-background:new 0 0 100 100;" xml:space="preserve"><g><line class="insert_inpoint1" x1="2.6" y1="50.5" x2="53.1" y2="50.5"/><g><line class="insert_inpoint1" x1="2.6" y1="50.5" x2="34.1" y2="50.5"/><g><polygon class="insert_inpoint1" points="30.2,63.8 53.1,50.5 30.2,37.2 "/></g></g></g><rect x="56.2" y="9" class="insert_inpoint2" width="40.7" height="83.8"/><polygon class="insert_inpoint1" points="77.7,9 56.2,31.8 56.2,92.8 96.8,92.8 96.8,9 "/></svg>`);

						let outpointClipIcon = $('<div>', {'class': 'actor_insert_setting insert_setting_icon insert_outpoint disable'});
							outpointClipIcon.html(`<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 100 100" style="enable-background:new 0 0 100 100;" xml:space="preserve"><polygon class="insert_outpoint4" points="14.3,92.8 85.8,92.8 85.8,9 14.2,9 "/><polygon class="insert_outpoint1" points="64.3,9 85.8,31.8 85.8,92.8 14.3,92.8 14.2,9 "/><g><line class="insert_outpoint3" x1="31.1" y1="50" x2="81.6" y2="50"/><g><line class="insert_outpoint3" x1="31.1" y1="50" x2="62.6" y2="50"/><g><polygon class="insert_outpoint3" points="58.7,63.3 81.6,50 58.7,36.7 "/></g></g></g></svg>`);


						let markerIcon = $('<div>', {'class': 'actor_insert_setting insert_setting_icon insert_marker disable'});
							markerIcon.html('<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"\
											viewBox="0 0 100 100" style="enable-background:new 0 0 100 100;" xml:space="preserve">\
										<polygon class="marker_icon" points="23.1,58.425 23.1,18 76.57,18 76.57,58.425 49.535,83 23.1,58.425 "/></svg>');

						checkbox_div.append(inpointClipIcon);
						checkbox_div.append(outpointClipIcon);
						checkbox_div.append(markerIcon);
						partsSelector.append(checkbox_div);

						var partsList = $('<div>', {'class':'uk-width-expand uk-flex uk-flex-left actor_parts_list'});
						var thumbnav = $('<div>', {'class':'td-thumbnav'});

						var ul = $('<ul>');
						var clips = actorObj.actor[i].clips;
						for(var j = 0; j < clips.length; j++){
							var li = $('<li>', {'class':'actor_thumb_parent', name:clips[j].clip, tree_path:clips[j].tree_path, group_index: actorObj.actor.length - 2 - i});
							var img = $('<img>', {'class':'actor_thumb'});
							var crop = clips[j].crop_path;
							if (crop && fs.existsSync(crop)) {
								img.attr('src', crop);
								li.append(img);
							} else {
								li.append($('<span>', {'uk-icon':'icon: question; ratio:2'}));
							}
							ul.append(li);
						}
						var li = $('<li>', {'class':'actor_thumb_parent', name:'このクリップを消す', tree_path:'delete', group_index: actorObj.actor.length - 2 - i});
						var dummy = $('<span>', {'uk-icon':'icon: trash; ratio:2'});
						li.append(dummy);
						ul.append(li);
						thumbnav[0].addEventListener('mousewheel', function(e) {
							const amount = 60;
							e.stopPropagation();
							var oEvent = e, 
								direction = oEvent.detail ? oEvent.detail * -amount : oEvent.wheelDelta, 
								position = $(this).scrollLeft();
							position += direction > 0 ? -amount : amount;
							$(this).scrollLeft(position);
							e.preventDefault();
						}, { passive: false });

						thumbnav.append(ul);
						partsList.append(thumbnav);
						partsSelector.append(partsList);
						actor.append(partsSelector);
						actor_root.append(actor);
					}
				}
			}
		});
	}

	function LoadActorStructure(path)	{
		json = window.cep.fs.readFile(path);
		if(json.err){
			if(json.err == window.cep.fs.ERR_NOT_FOUND) {
				alert('"' + path + '"が見つかりません。');
				return null;
			} else {
				alert("err : " + json.err);
			}
		}
		return JSON.parse(json.data);
	}

	function SaveJson(obj, path) {
		return window.cep.fs.writeFile(path, JSON.stringify(obj)).err;
	}

	function mogrtUpdate() {
		let select_mogrt = document.getElementById('select_mogrt');
		var csInterface = new CSInterface();
		csInterface.evalScript('$._PPP_.getMGTClipName()', function(names) {
			var nameList = names.split(',');
			for(let i = 0; i < nameList.length; i++){
				if(i < select_mogrt.childNodes.length){
					select_mogrt.childNodes[i].innerHTML = nameList[i];
					select_mogrt.childNodes[i].value =  nameList[i];
				} else {
					let option = document.createElement('option');
					option.setAttribute('value', nameList[i]);
					option.innerHTML = nameList[i];
					select_mogrt.appendChild(option);
				}
			}
			while(nameList.length < select_mogrt.childNodes.length) {
				select_mogrt.removeChild(select_mogrt.lastChild);
			}
		});
	}
	function actorSelectBoxUpdate() {
		let select_actor = $('#select_actor_setting');
		let actor_linknav = $('.actor_linknav ul');
		let actor_switcher = $('#actor_switcher');
		actor_linknav.empty();
		actor_switcher.empty();

		var csInterface = new CSInterface();
		csInterface.evalScript('$._PPP_.getActorBinName()', function(names) {
			select_actor.each(function() {
				var nameList = names.split(',');
				for(let i = 0; i < nameList.length; i++) {
					var act_switch = $('<li>', {'class':'', sequence:i});
					act_switch.append($('<div>', {'class':'actor_component', sequence:i}));
					actor_switcher.append(act_switch);

					var li = $('<li>', {'class': 'actor_sequence_link uk-width-auto unlink', sequence : i});
					var div_icon = $('<div>', {'class':'actor_sequence_link_icon', 'uk-icon':'ban'});
					var div_label = $('<div>', {'class':'actor_sequence_link_label'});
						div_label.html(nameList[i]);
					li.append(div_icon);
					li.append(div_label);
					actor_linknav.append(li);
					
					if(i < this.childNodes.length){
						this.childNodes[i].innerHTML = nameList[i];
						this.childNodes[i].value =  nameList[i];
					} else {
						let option = document.createElement('option');
						option.setAttribute('value', nameList[i]);
						option.innerHTML = nameList[i];
						this.appendChild(option);
					}
				}
				while(nameList.length < this.childNodes.length) {
					this.removeChild(this.lastChild);
				}
			});
		});
	}
	
	function clearActorSettingPanel() {
		var notuse = $('#actor_not_use');
		notuse.empty();
		notuse.html('<summary>Not use</summary>');
		$('#root_container').empty();
	}
	
	function addActorSettingPanel() {
		var actorSettingComponent = $('#actor_setup');
		SortableSet();
		$('#add_group').change(function(e) {
			let name = $(this).val();
			if(name !== ''){
				AddGroup(name);
				$(this).val('');
			}
		});
	}

	function actorSettingStart(force_initialize) {
		clearActorSettingPanel();
		addActorSettingPanel();
		var actor = document.getElementById("select_actor_setting");
		var csInterface = new CSInterface();

		csInterface.evalScript('$._PPP_.getActorStructureMediaPath("' + actor.value + '")', function(result) {
			let mediaPathList = result.split(',');
			if(result !== '' && mediaPathList.length == 1 && !force_initialize) {
				$('#actor_setting_save_button.disable').removeClass('disable');
				$('#actor_setting_initialize.disable').removeClass('disable');
				var actorObj = LoadActorStructure(mediaPathList[0]);
				for(var i = 0; i < actorObj.actor.length - 1; i++) {
					var group = AddGroup(actorObj.actor[i].group);
					var clips = actorObj.actor[i].clips;
					for(var j = 0; j < clips.length; j++) {
						if(fs.existsSync(clips[j].src_path) ) {
							AddActorClip(group, clips[j].clip, clips[j].src_path, clips[j].tree_path, clips[j].crop_path);
						}
					}
				}
				var group = $('#actor_not_use');
				var clips = actorObj.actor[actorObj.actor.length - 1].clips;
				for(var j = 0; j < clips.length; j++) {
					AddActorClip(group, clips[j].clip, clips[j].src_path, clips[j].tree_path, clips[j].crop_path);
				}
			} else {
				csInterface.evalScript('$._PPP_.getActorStructure("'+ actor.value + '")', function(struct) {
					if(struct) {
						$('#actor_setting_save_button.disable').removeClass('disable');
						$('#actor_setting_initialize.disable').removeClass('disable');
						let elmNum = 4;
						var structList = struct.split(',');
						let length = structList.length / elmNum;
						var prevGroupName = ""
						var prevGroup = null;
						for(let i = 0; i < length; i++) {
							let currentGroupName = structList[i * elmNum + 1];
							if(currentGroupName !== prevGroupName){
								prevGroup = AddGroup(currentGroupName);
								prevGroupName = currentGroupName;
							}
							AddActorClip(prevGroup, structList[i * elmNum], structList[i * elmNum + 2], structList[i * elmNum + 3], '');
						}
					} else {
						$('#actor_setting_save_button').addClass('disable');
						$('#actor_setting_initialize').addClass('disable');
					}
				});
			}
		});	
	}

	function importMGT() {
		var mogrtPathList = window.cep.fs.showOpenDialog(true, false, 'モーショングラフィックステンプレート', '', ['.mogrt']).data;
		var csInterface = new CSInterface();
		if(mogrtPathList != '') {
			csInterface.evalScript('$._PPP_.importMOGRTFile("' + mogrtPathList + '")');
		}
	}

	function insertSubtitleFromTextarea() {
		var mogrt = document.getElementById("select_mogrt");
		var text = document.getElementById("subtitles");
		const presetTag = $('#preset_tag').val();
		let replaceReg = null;
		if(('#subtitle_replace').val() != '') {
			try {
				replaceReg = new RegExp($('#subtitle_replace').val(), $('#subtitle_replace_flag').val());
			} catch (e) {
				alert(e);
			}
		}
		const replaceAfter = $('#subtitle_replace_after').val();
		var csInterface = new CSInterface();
		csInterface.evalScript('$._PPP_.insertSubtitle("' + mogrt.value + '","'
		+ text.value.slice(text.value.indexOf(presetTag) + 1).replace(/\//g, '').replace(newLineReg, '/').replace(/\"/g, '\\"').replace(replaceReg, replaceAfter) + '")');
	}

	function getJSISText(path) {
		if(fs.existsSync(path)) {
			const data = fs.readFileSync(path);
			return Encoding.convert(data, {from: 'SJIS', to: 'UNICODE', type: 'string'});
		}
		return null;
	}

	const Encoding = require('encoding-japanese');
	function insertSubtitleFromTextFile() {
		var csInterface = new CSInterface();
		csInterface.evalScript('$._PPP_.getTragetAudioClipMediaPath()', function(result){
			let replaceReg = null;
			if($('#subtitle_replace').val() != '') {
				try {
					replaceReg = new RegExp($('#subtitle_replace').val(), $('#subtitle_replace_flag').val());
				} catch (e) {
					alert(e);
				}
			}
			const replaceAfter = $('#subtitle_replace_after').val();
			let mediaPathList = result.split(',');
			let textList = [];
			const OSVersion = csInterface.getOSInformation();
			let dirSeparater = '/';
			if(OSVersion.includes('Windows')) {
				dirSeparater = '\\';
			}
			const presetTag = $('#preset_tag').val();
			for(let i = 0; i < mediaPathList.length; i++) {
				const path = mediaPathList[i].slice(0, mediaPathList[i].lastIndexOf('.') + 1) + 'txt';
				let text = getJSISText(path);
				if(text != null) {
					if(presetTag !== '') {
						textList.push(text.slice(text.indexOf(presetTag) + 1).replace(newLineReg, '\\n').replace(/\//g, '').replace(/\"/g, '\\"').replace(replaceReg, replaceAfter));
					} else {
						textList.push(text.replace(newLineReg, '\\n').replace(/\//g, '').replace(/\"/g, '\\"').replace(replaceReg, replaceAfter));
					}
				} else {
					const lastDirSepIndex = mediaPathList[i].lastIndexOf(dirSeparater) + 1;
					textList.push(mediaPathList[i].slice(lastDirSepIndex, mediaPathList[i].lastIndexOf('.')).replace(/\//g, ''));
				}
			}
			var mogrt = document.getElementById("select_mogrt");
			csInterface.evalScript('$._PPP_.insertSubtitle("' + mogrt.value + '","' + textList.join('/') + '")');
		});	
	}

	let cropImageCounter = 0;
	let cropImageSize = 0;
	function _ActorStructureSave(save_structure_file_path, currentActorObj)
	{
		if(!save_structure_file_path) {
			const actorName = $("#select_actor_setting").val();
			save_structure_file_path = window.cep.fs.showSaveDialogEx('構成ファイルの保存先', '', ['txt'], actorName + '.txt').data;
			if(!save_structure_file_path) return;
		}

		var obj = [];	
		var crop_dir = '';
		var crop_list = [];

		let groupList = $('.container.dragitem');
		for(var i = 0; i < groupList.length; i++) {
			var group_obj = { 
				group : groupList[i].getAttribute('group'),
				clips : []
			};
			var clips = $(groupList[i]).children('.dragitem');
			for(var j = 0; j < clips.length; j++){
				let crop_path = clips[j].getAttribute('crop_path');
				let clip_name = clips[j].getAttribute('clip');
				if(crop_path === '' || !fs.existsSync(crop_path)) {
					if(!crop_dir){
						crop_dir = window.cep.fs.showOpenDialogEx(false, true, 'サムネイルの保存先', null).data;
						if(crop_dir == '') return;
						crop_dir += '/';
					}
					let src_path = clips[j].getAttribute('src');
					let lastIndex = src_path.lastIndexOf(".");
					crop_path = crop_dir + clip_name + GetUUID() + src_path.substr(lastIndex);
					crop_list.push({src:src_path, dst:crop_path});
				}
				var clip_pbj = {
					clip: clip_name,
					src_path: clips[j].getAttribute('src'),
					tree_path: clips[j].getAttribute('tree_path'),
					crop_path: crop_path
				};
				group_obj.clips.push(clip_pbj);
			}
			obj.push(group_obj);
		}

		var group_obj = { 
			group : 'notuse',
			clips : []
		};
		var clips = $('#actor_not_use').children('.dragitem');
		for(var j = 0; j < clips.length; j++){
			let crop_path =  clips[j].getAttribute('crop_path');
			let clip_name = clips[j].getAttribute('clip');
			if(crop_path === '' || !fs.existsSync(crop_path)) {
				if(!crop_dir) {
					crop_dir = window.cep.fs.showOpenDialog(false, true, 'サムネイルの保存先', '').data;
					if(crop_dir == '') return;
					crop_dir += '/';
				}
				let src_path = clips[j].getAttribute('src');
				let lastIndex = src_path.lastIndexOf(".");
				crop_path = crop_dir + clip_name + GetUUID() + src_path.substr(lastIndex);
				crop_list.push({src:src_path, dst:crop_path});
			}
			var clip_pbj = {
				clip: clips[j].getAttribute('clip'),
				src_path: clips[j].getAttribute('src'),
				tree_path: clips[j].getAttribute('tree_path'),
				crop_path: crop_path
			};
			group_obj.clips.push(clip_pbj);
		}
		obj.push(group_obj);
		var wrapper = {actor: obj};
		if(currentActorObj) {
			wrapper['clipset'] = currentActorObj.clipset;
		} else {
			wrapper['clipset'] = {};
		}
		const err = SaveJson(wrapper, save_structure_file_path);
		if(err != window.cep.fs.NO_ERROR) {
			alert(CEP_ERROR_TO_MESSAGE[err]);
		}
		$('#actor_setting_save_button').addClass('disable');
		$('#actor_setting_initialize').addClass('disable');

		cropImageCounter = 0;
		cropImageSize = crop_list.length;
		if(cropImageSize > 0) {
			$('#mainfunc').addClass('disable');
			$('#busy_notification').addClass('uk-open');
			$('#busy_notification').attr('style', 'display: block;');
			for(var i = 0; i < cropImageSize; i++) {
				save_transparent_crop(crop_list[i].src, crop_list[i].dst, cropImageCallback);
			}
		}
		return save_structure_file_path;
	}

	function cropImageCallback(){
		cropImageCounter += 1;
		if(cropImageCounter === cropImageSize){
			$('#mainfunc').removeClass('disable');
			$('#busy_notification').removeClass('uk-open');
			$('#busy_notification').attr('style', '');
		}
	}
	
	const Jimp = require('jimp');
	const autocrop = require('autocropmodule/autocropmodule.js');
	function transparent_crop_async(path, callback)	{
		Jimp.read(path, (err, image) => {
			if (!err) {
				image.autocrop = autocrop;
				image.autocrop(5);
				image.getBase64Async(Jimp.AUTO).then(callback);
			} 
		});
	}

	function save_transparent_crop(src_path, dist_path, callback) {
		Jimp.read(src_path, (err, image) => {
			if (!err) {
				image.autocrop = autocrop;
				image.autocrop(5);
				image.write(dist_path);
				if(callback) callback();
			}
		});
	}

	function tokenInsertNewLine(tokens, maxCharactorNum, asciiIsHalf) {
		let processedText = [];
		let tokensLength = tokens.length;
		let wordList = [];
		let prevWordPos = 0;
		let prevIndex = -1;
		let offset = 0;
		let split_fail = 0;
		
		for(let i = 0; i < tokensLength; i++) {
			if(asciiIsHalf) {
				const arr = tokens[i].surface_form.match(asciiReg);
				if(arr) {
					offset = offset + arr.length * 0.5;
				}
			}
			const wordLength = tokens[i].word_position + tokens[i].surface_form.length;
			if(Math.ceil(wordLength - prevWordPos - offset) > maxCharactorNum) {
				let j = i - 1;
				let secondChoice = -1;
				let thirdChoice = -1;
				let fourthChoice = -1;
				for(; j > prevIndex; j--) {
					if(tokens[j + 1].pos_detail_1 !== '読点' && tokens[j + 1].pos_detail_1 !== '句点') {
						if((tokens[j].pos === '助詞' && tokens[j + 1].pos !== '動詞') || 
							tokens[j].pos_detail_1 === '読点' || 
							tokens[j].pos_detail_1 === '句点' || 
							tokens[j].pos_detail_1 === '空白') {
							processedText.push(wordList.join(''));
							prevWordPos = tokens[j].word_position;
							i = j;
							prevIndex = j;
							break;
						} else if(secondChoice === -1 && tokens[j].pos === '助動詞') {
							secondChoice = j;
						} else if(thirdChoice === -1 && tokens[j].pos === '形容詞') {
							thirdChoice = j;
						} else if(fourthChoice === -1 && tokens[j].pos === '助詞') {
							fourthChoice = j;
						}
					}
					wordList.pop();
				}
				if(wordList.length === 0) {
					let choiceIndex = i - 1;
					if(secondChoice !== -1) {
						choiceIndex = secondChoice;
					} else if(thirdChoice !== -1) {
						choiceIndex = thirdChoice;
					} else if(fourthChoice !== -1) {
						choiceIndex = fourthChoice;
					}
					if(prevIndex !== choiceIndex) {
						for(let k = prevIndex + 1; k <= choiceIndex; k++) {
							wordList.push(tokens[k].surface_form);
						}
					} else {
						split_fail = -1;
						choiceIndex = prevIndex + 1;
						wordList.push(tokens[choiceIndex].surface_form);
					}
					processedText.push(wordList.join(''));
					prevWordPos = tokens[choiceIndex].word_position;
					i = choiceIndex;
					prevIndex = choiceIndex;
				}
				wordList = [];
				offset = 0;
			} else {
				wordList.push(tokens[i].surface_form);
			}
		}
		if(wordList.length > 0) {
			processedText.push(wordList.join(''));
		}
		return [processedText, split_fail];
	}

	var kuromoji = require('kuromoji');
	function auto_new_line(maxCharactorNum, maxLineNum, insertMarkerColor, warningMarkerColor, asciiIsHalf, initNewLine, autoNewLine) {
		var csInterface = new CSInterface();
		csInterface.evalScript('$._PPP_.AutoNewLine_GetSourceText()', function(result){
			let textList = result.split('/');
			var extPath = csInterface.getSystemPath(SystemPath.EXTENSION);
			var builder = kuromoji.builder({dicPath: extPath + '/node_modules/kuromoji/dict'});
			builder.build(function(err, tokenizer) {
				if(err){throw err}
				let processedText = [];
				let processedFlag = [];
				const textListLength = textList.length;
				if(initNewLine) {
					for(let i = 0; i < textListLength; i++) {
						textList[i] = textList[i].replace(newLineReg, '');
					}
				}
				for(let i = 0; i < textListLength; i++) {
					let oneLineTextList = textList[i].split(newLineReg);
					let preProcessedText = [];
					let process = -1;
					for(let j = 0; j < oneLineTextList.length; j++) {
						let charactorCount = oneLineTextList[j].length;
						if(asciiIsHalf) {
							const arr = oneLineTextList[j].match(asciiReg);
							if(arr) {
								charactorCount = Math.ceil(charactorCount - arr.length * 0.5);
							}
						}
						if(charactorCount > maxCharactorNum) {
							if(autoNewLine) {
								let tokens = tokenizer.tokenize(oneLineTextList[j]);
								let [newLineText , split_fail] = tokenInsertNewLine(tokens, maxCharactorNum, asciiIsHalf);
								Array.prototype.push.apply(preProcessedText, newLineText);
								if(split_fail) {
									process = 2;
								}
							} else {
								preProcessedText.push(oneLineTextList[j]);
							}
							if(process !== 2) {
								process = 1;
							}
						} else {
							preProcessedText.push(oneLineTextList[j]);
						}
					}

					if (preProcessedText.length > maxLineNum) {
						process = 2;
					}
					processedText.push(preProcessedText.join('\n'));
					if(process === 1) {
						processedFlag.push(insertMarkerColor);
					} else if(process === 2) {
						processedFlag.push(warningMarkerColor);
					} else {
						processedFlag.push(-1);
					}
				}
				csInterface.evalScript('$._PPP_.AutoNewLine_Replace("'+ processedText.join('/').replace(newLineReg, '\\n').replace(/\"/g, '\\"') +'","' + processedFlag.join('/') + '")', function(result) {
				});				
			});
		});
	}

	function countSelectedClipTextLength() {
		var csInterface = new CSInterface();
		csInterface.evalScript('$._PPP_.GetSelectedClipText()', function(result){
			if(result) {
				let charactorCount = result.length;
				if($('#auto_newline_ascii').prop('checked')) {
					const arr = result.match(asciiReg);
					if(arr) {
						charactorCount = Math.floor(charactorCount - arr.length * 0.5);
					}
				}
				$('#auto_newline_maxcount').val(charactorCount);
				$('#auto_newline_maxcount').change();
			}
		});
	}

	function autoNewLine_ExecuteButton() {
		let maxCharactorNum = 10;
		let insertMarkerColor = -1;
		let warningMarkerColor = -1;
		let maxLineNum = 10000;
		if($('#auto_newline_marker').prop('checked')) {
			let marker_index = $('#auto_newline_normal_marker_color div:nth-child(2)');
			for(insertMarkerColor = 0; insertMarkerColor < 8; insertMarkerColor++) {
				if(marker_index.hasClass('merker_color_selected')) {
					break;
				}
				marker_index = marker_index.next();
			}

			marker_index = $('#auto_newline_warning_marker_color div:nth-child(2)');
			for(warningMarkerColor = 0; warningMarkerColor < 8; warningMarkerColor++) {
				if(marker_index.hasClass('merker_color_selected')) {
					break;
				}
				marker_index = marker_index.next();
			}

			if(insertMarkerColor >= 8) insertMarkerColor = 0;
			if(warningMarkerColor >= 8) warningMarkerColor = 1;
			maxLineNum = Number($('#auto_newline_maxlinecount').val());
			if(maxLineNum < 1) maxLineNum = 1;
		}
		maxCharactorNum = Number($('#auto_newline_maxcount').val());
		if(maxCharactorNum < 1) maxCharactorNum = 1;

		const asciiIsHalf = $('#auto_newline_ascii').prop('checked');
		const initNewLine = $('#auto_newline_flatten').prop('checked');
		const autoNewLine = $('#auto_newline_insert').prop('checked');
		auto_new_line(maxCharactorNum, maxLineNum, insertMarkerColor, warningMarkerColor, asciiIsHalf, initNewLine, autoNewLine);
	}

	function autoNewLineMarkerUIUpdate() {
		const checkbox = $('#auto_newline_marker');
		const parent = checkbox.closest('div')
		if(checkbox.prop('checked')) {
			let nextElm = parent.next();
			nextElm.removeClass('events_disable');
			nextElm = nextElm.next();
			nextElm.removeClass('events_disable');
			nextElm = nextElm.next();
			nextElm.removeClass('events_disable');
		} else {
			let nextElm = parent.next();
			nextElm.addClass('events_disable');
			nextElm = nextElm.next();
			nextElm.addClass('events_disable');
			nextElm = nextElm.next();
			nextElm.addClass('events_disable');
		}
	}

	// AutoNewLineInitialize
	CustomInitialize['auto_newline_custum_initialize'] = function () {
		const category = ExtensionSettings['autonewline'];
		const normal_marker_parent = $('#auto_newline_normal_marker_color');
		const warning_marker_parent = $('#auto_newline_warning_marker_color');
		if(category) {
			let marker_color = category['auto_newline_normal_marker_color'];
			if(marker_color) {
				normal_marker_parent.children().eq(Number(marker_color)).click();
			} else {
				normal_marker_parent.children().eq(1).click();
			}
			marker_color = category['auto_newline_warning_marker_color'];
			if(marker_color) {
				warning_marker_parent.children().eq(Number(marker_color)).click();
			} else {
				warning_marker_parent.children().eq(2).click();
			}
		} else {
			normal_marker_parent.children().eq(1).click();
			warning_marker_parent.children().eq(2).click();
		}
		autoNewLineMarkerUIUpdate();
	}

	function LoadSettings()	{
		var csInterface = new CSInterface();
		csInterface.evalScript('$._PPP_.getSettingsMediaPath()', function(result){
			if(result) {
				json = window.cep.fs.readFile(result);
				if(json.err){
					$('#setting_file_not_exist_icon').css('visibility','visible');
					if(json.err != window.cep.fs.ERR_NOT_FOUND) {
						alert(CEP_ERROR_TO_MESSAGE[json.err]);
					}
				} else {
					$('#setting_file_not_exist_icon').css('visibility','hidden');
					ExtensionSettingsFilePath = result;
					ExtensionSettings = JSON.parse(json.data);
				}
			} else {
				$('#setting_file_not_exist_icon').css('visibility','visible');
			}
			SettingApply();
		});
	}

	function NewSettingFile() {
		const savedir = window.cep.fs.showOpenDialogEx(false, true, '設定の保存先フォルダの選択', null).data[0];
		if(savedir) {
			ExtensionSettingsFilePath = savedir + '/2dActorTools_settings.txt';
			const err = SaveSetting();
			if(err == window.cep.fs.NO_ERROR){
				const csInterface = new CSInterface();
				csInterface.evalScript('$._PPP_.importSettingsFile("' + ExtensionSettingsFilePath + '")');
				$('#setting_file_not_exist_icon').css('visibility','hidden');
				$('#setting_save_modal_close').click();
			} else {
				alert(CEP_ERROR_TO_MESSAGE[err]);
			}
		}
	}

	function ImportSettingFile() {
		var settingFilePath = window.cep.fs.showOpenDialog(false, false, '2dActorTools setting file', '', ['.txt']).data;
		if(settingFilePath != '') {
			var csInterface = new CSInterface();
			csInterface.evalScript('$._PPP_.importSettingsFile("' + settingFilePath + '")', function(e) {
				LoadSettings();
			});
			$('#setting_file_not_exist_icon').css('visibility','hidden');
			$('#setting_save_modal_close').click();
		}
	}

	function SettingUpdate(category, id, value) {
		if(!ExtensionSettings[category]) {
			ExtensionSettings[category] = {};
		}
		ExtensionSettings[category][id] = value;
		SaveSetting();
	}

	function SaveSetting() {
		if(ExtensionSettingsFilePath) {
			return SaveJson(ExtensionSettings, ExtensionSettingsFilePath);
		}
	}

	function SaveAutoImportSettings() {
		let autoImportSettings = {}
		$('#auto_import_root').children('.watch_dir_element').each(function(i, o) {
			let watch_dir = {}; 
			watch_dir['import_dir_path'] = $(o).find('.auto_import_dir_path').val();
			const tbody = $(o).find('tbody');
			let rules = [];
			tbody.children('tr').each(function(tr_i, tr_o) {
				const tdList = $(tr_o).children('td');
				let rule = {};
				const selectbox = tdList.children('select');
				rule['pattern'] = tdList.children('input').eq(0).val();
				rule['source'] = selectbox.eq(0).val();
				rule['import_bin'] = tdList.children('button').eq(0).html();
				rule['track_number'] = selectbox.eq(1).val();
				rules.push(rule);
			});
			watch_dir['rules'] = rules;
			autoImportSettings[i] = watch_dir;
		});
		SettingUpdate('auto_import', 'auto_import_settings_id', autoImportSettings);
	}
	
	// AutoImportInitialize
	CustomInitialize['auto_import_custum_initialize'] = function () {
		const category = ExtensionSettings['auto_import'];
		if(category) {
			const settingRoot = category['auto_import_settings_id'];
			for(index in settingRoot) {
				const dirElm = addAutoImportWatchDir();
				const watch_dir = settingRoot[index];
				const watch_dir_path = watch_dir['import_dir_path'];
				const watch_dir_input = dirElm.find('.auto_import_dir_path');
				watch_dir_input.val(watch_dir_path);
				if(fs.existsSync(watch_dir_path)) {
					watch_dir_input.addClass('tdact_setting_ok');
				} else {
					watch_dir_input.addClass('tdact_setting_error');
				}
				const tbody = dirElm.find('tbody');
				const rules = watch_dir['rules'];
				const rulesLength = rules.length;
				for(let i = 0; i < rulesLength; i++) {
					const rule = rules[i];
					const tr = addAutoImportRule(tbody);
					const tdList = tr.children('td');
					const selectbox = tdList.children('select');
					tdList.children('input').eq(0).val(rule['pattern']);
					selectbox.eq(0).val(rule['source']);
					const binTreePath = rule['import_bin'];
					const binButton = tdList.children('button').eq(0);
					binButton.html(binTreePath);
					const csInterface = new CSInterface();
					csInterface.evalScript('$._PPP_.existBinTreePath("' + binTreePath + '")', function(result) {
						binButton.attr('uk-tooltip', binTreePath);
						if(result) {
							binButton.addClass('tdact_setting_ok');
						} else {
							binButton.addClass('tdact_setting_error');
						}
					});
					
					const trackNum = Number(rule['track_number']);
					const trackSelectbox = selectbox.eq(1);
					const currentTrackNum = trackSelectbox.children().length;
					if(currentTrackNum <= trackNum) {
						let value = currentTrackNum;
						while(trackSelectbox.children().length <= trackNum) {
							const op = $('<option>', {'value':value});
								op.html(value);
								trackSelectbox.append(op);
							value += 1;
						}
						trackSelectbox.removeClass('tdact_setting_ok');
						trackSelectbox.addClass('tdact_setting_error');
						trackSelectbox.attr('uk-tooltip', currentTrackNum + ' 以下を選択してください');
						trackSelectbox.attr('max_track_num', currentTrackNum);
					}
					trackSelectbox.val(trackNum);
					trackSelectbox.change();
				}
			}
		}
	}

	function SaveSettingValueFromElement(jq_target) {
		const value = jq_target.val();
		const category = jq_target.attr('category');
		const id = jq_target.attr('id');
		SettingUpdate(category, id, value);
	}

	function SaveSettingCheckFromElement(jq_checkbox) {
		let value = 0;
		if(jq_checkbox.prop('checked')) value = 1;		
		const category = jq_checkbox.attr('category');
		const id = jq_checkbox.attr('id');
		SettingUpdate(category, id, value);
	}

	function SettingApply() {
		for(category in ExtensionSettings) {
			let setting = ExtensionSettings[category];
			for(id in setting) {
				const target = $('#' + id);
				if(target) {
					const type = target.attr('type');
					if(type === 'text' || type === 'selectbox') {
						target.val(setting[id]);
					} else if(type === 'checkbox') {
						if(setting[id] == '0') {
							target.prop('checked', false);
						} else {
							target.prop('checked', true);
						}
					}
				}
			}
		}

		for(id in CustomInitialize) {
			CustomInitialize[id]();
		}
	}

	function triggerOverriteClip_ExecuteButton() {
		const trackNumElm = $('#trigger_clip_override_target_track');
		if(!trackNumElm.hasClass('tdact_setting_ok')) return;

		const startTriggerPathElm = $('#trigger_clipstart_clippath');
		const endTriggerPathElm = $('#trigger_clipend_clippath');
		let startTriggerClipTreePath = '';
		let endTriggerClipTreePath = '';
		if(startTriggerPathElm.hasClass('tdact_setting_ok')) {
			startTriggerClipTreePath = startTriggerPathElm.html();
		}
		if(endTriggerPathElm.hasClass('tdact_setting_ok')) {
			endTriggerClipTreePath = endTriggerPathElm.html();
		}
		const trackNum = trackNumElm.val() - 1;
		const targetSequence = $('#trigger_clip_override_target_seq').val();

		let startClipEndFlag = 0;
		if(startTriggerPathElm.find('.insert_inpoint').hasClass('enable')) startClipEndFlag += 1;
		if(startTriggerPathElm.find('.insert_outpoint').hasClass('enable')) startClipEndFlag += 2;
		if(startTriggerPathElm.find('.insert_marker').hasClass('enable')) startClipEndFlag += 4;
		let endClipEndFlag = 0;
		if(endTriggerPathElm.find('.insert_inpoint').hasClass('enable')) endClipEndFlag += 1;
		if(endTriggerPathElm.find('.insert_outpoint').hasClass('enable')) endClipEndFlag += 2;
		if(endTriggerPathElm.find('.insert_marker').hasClass('enable')) endClipEndFlag += 4;
		const csInterface = new CSInterface();
		csInterface.evalScript('$._PPP_.triggerClipOverwrite("' + targetSequence + '","' + trackNum + '","' + startTriggerClipTreePath + '","' + endTriggerClipTreePath + '","' + startClipEndFlag + '","' + endClipEndFlag + '")', function() {});
	}

	CustomInitialize['trigger_clip_custum_initialize'] = function () {
		const category = ExtensionSettings['trigger_clip_override'];
		if(category) {
			const trackIndex = category['trigger_clip_override_target_track'];
			if(trackIndex) { 
				const trackSelectbox = $('#trigger_clip_override_target_track');
				let value = 1;
				while(trackSelectbox.children().length <= trackIndex) {
					const op = $('<option>', {'value':value});
						op.html(value);
						trackSelectbox.append(op);
					value += 1;
				}
				trackSelectbox.removeClass('tdact_setting_ok');
				trackSelectbox.attr('max_track_num', 1);
				trackSelectbox.val(trackIndex);
			}
			const startTriggerClipPath = category['trigger_clipstart_clippath'];
			if(startTriggerClipPath) {
				const clipButtonElm = $('#trigger_clipstart_clippath');
				clipButtonElm.html(startTriggerClipPath);
				const csInterface = new CSInterface();
				csInterface.evalScript('$._PPP_.existClipTreePath("' + startTriggerClipPath + '")', function(result) {
					if(result) {
						clipButtonElm.attr('uk-tooltip', startTriggerClipPath);
						clipButtonElm.addClass('tdact_setting_ok');
						clipButtonElm.removeClass('tdact_setting_error');
					}
				});
			}
			const endTriggerClipPath = category['trigger_clipend_clippath'];
			if(endTriggerClipPath) {
				const clipButtonElm = $('#trigger_clipend_clippath');
				clipButtonElm.html(endTriggerClipPath);
				const csInterface = new CSInterface();
				csInterface.evalScript('$._PPP_.existClipTreePath("' + endTriggerClipPath + '")', function(result) {
					if(result) {
						clipButtonElm.attr('uk-tooltip', endTriggerClipPath);
						clipButtonElm.addClass('tdact_setting_ok');
						clipButtonElm.removeClass('tdact_setting_error');
					}
				});
			}
			const merkerInit = function(id) {
				let insert = category[id];
				if(insert) {
					const icon = $('#' + id);
					if(insert == 'enable') {
						icon.addClass('enable');
						icon.removeClass('disable');
					} else {
						icon.removeClass('enable');
						icon.addClass('disable');
					}
				}
			}
			merkerInit('trgclp_str_ins_in');
			merkerInit('trgclp_str_ins_out');
			merkerInit('trgclp_str_ins_mkr');
			merkerInit('trgclp_end_ins_in');
			merkerInit('trgclp_end_ins_out');
			merkerInit('trgclp_end_ins_mkr');
		}
		$('#trigger_clip_override_target_seq').change();
	}
</script>

</html>
